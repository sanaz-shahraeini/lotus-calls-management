{% extends "base.html" %}
{% load static %}
{% load dashboardTags %}

{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- SheetJS library for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Modern dashboard styles --> 
<link rel="stylesheet" href="{% static 'css/dashboard-inline.css' %}">
{% endblock head_extra %}

{% block main %}
<div class="min-h-screen relative dashboard-page-root">
    <!-- Main Content Area -->
    <main class="px-4 py-6 max-w-full">
        <!-- Dashboard Content -->
        <div class="space-y-6">
            <!-- Dashboard Header with Gradient Background -->
            <div class="dashboard-header p-6 md:p-8 card max-w-[1400px] mx-auto dashboard-container-1400">
                <div class="relative z-10 flex items-center justify-between">
                    <!-- Left side with title -->
                    <div class="flex-1">
                        <h1 class="text-2xl md:text-3xl font-bold text-white">داشبورد لوتوس</h1>
                        <p class="text-white opacity-80 mt-1 font-light">مدیریت و گزارش تماس‌ها  {{ now|date:"Y/m/d"|convertDatesToHijri }}</p>
                    </div>
                    
                    <!-- Right side with compact search -->
                    <div class="flex items-center mr-8">
                        <!-- Compact, stylish search box -->
                        <div class="relative">
                            <input
                                type="search"
                                id="quickSearch"
                                placeholder="جستجو..."
                                class="w-44 md:w-48 h-9 pr-3 pl-10 bg-white/30 border border-white/25 rounded-full text-slate-800 text-sm placeholder-slate-600 focus:outline-none focus:ring-2 focus:ring-white/30 focus:bg-white/80 transition-all duration-200 focus:w-52 dashboard-quicksearch-input"
                            />
                            <div class="absolute left-0 top-0 h-full flex items-center pl-4 dashboard-quicksearch-icon">
                                <i class="fa-solid fa-search text-slate-700 text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards - Modern UI -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 md:gap-6 mb-6 md:mb-8" id="statsCards">
                <div class="stat-card total card bg-white p-6 hover:border-blue-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 stat-icon bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                            <i class="fa-solid fa-phone-volume text-xl"></i>
                        </div>
                        <div class="bg-blue-50 text-blue-600 text-xs font-medium px-2.5 py-1 rounded-full">
                            <i class="fa-solid fa-chart-simple ml-1"></i>
                            کل تماس‌ها
                        </div>
                    </div>
                    <h3 class="text-3xl font-bold text-slate-800">{{ dashPage.paginator.count|default:"0" }}</h3>
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-slate-500">مجموع تماس‌های ثبت شده</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center text-sm">
                            <i class="fa-solid fa-clock text-slate-400 ml-2"></i>
                            <span class="text-slate-500">آخرین بروزرسانی: چند دقیقه پیش</span>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card incoming card bg-white p-6 hover:border-green-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 stat-icon bg-green-100 rounded-full flex items-center justify-center text-green-600">
                            <div class="relative">
                                <i class="fa-solid fa-phone text-xl"></i>
                                <i class="fa-solid fa-arrow-down text-xs absolute -bottom-3 -right-3"></i>
                            </div>
                        </div>
                        <div class="bg-green-50 text-green-600 text-xs font-medium px-2.5 py-1 rounded-full">
                            <i class="fa-solid fa-arrow-down ml-1"></i>
                            ورودی
                        </div>
                    </div>
                    <h3 class="text-3xl font-bold text-slate-800">{{ incoming_calls_count|default:"0" }}</h3>
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-slate-500">تماس‌های دریافت شده</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-green-600 font-medium flex items-center">
                                <i class="fa-solid fa-circle-check ml-2"></i>
                                موفق
                            </span>
                            <span class="text-sm text-slate-500">
                                {% if dashPage.paginator.count > 0 and incoming_calls_count > 0 %}{{ incoming_calls_count|floatformat:0 }}/{{dashPage.paginator.count|floatformat:0}} ({% widthratio incoming_calls_count dashPage.paginator.count 100 %}%){% else %}0%{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card outgoing card bg-white p-6 hover:border-yellow-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 stat-icon bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600">
                            <div class="relative">
                                <i class="fa-solid fa-phone text-xl"></i>
                                <i class="fa-solid fa-arrow-up text-xs absolute -top-3 -left-3"></i>
                            </div>
                        </div>
                        <div class="bg-yellow-50 text-yellow-600 text-xs font-medium px-2.5 py-1 rounded-full">
                            <i class="fa-solid fa-arrow-up ml-1"></i>
                            خروجی
                        </div>
                    </div>
                    <h3 class="text-3xl font-bold text-slate-800">{{ outgoing_calls_count|default:"0" }}</h3>
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-slate-500">تماس‌های ارسال شده</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-yellow-600 font-medium flex items-center">
                                <i class="fa-solid fa-signal ml-2"></i>
                                فعال
                            </span>
                             <span class="text-sm text-slate-500">
                                {% if dashPage.paginator.count > 0 and outgoing_calls_count > 0 %}{{ outgoing_calls_count|floatformat:0 }}/{{dashPage.paginator.count|floatformat:0}} ({% widthratio outgoing_calls_count dashPage.paginator.count 100 %}%){% else %}0%{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card missed card bg-white p-6 hover:border-red-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-14 h-14 stat-icon bg-red-100 rounded-full flex items-center justify-center text-red-600">
                            <i class="fa-solid fa-phone-slash text-xl"></i>
                        </div>
                        <div class="bg-red-50 text-red-600 text-xs font-medium px-2.5 py-1 rounded-full">
                            <i class="fa-solid fa-triangle-exclamation ml-1"></i>
                            از دست رفته
                        </div>
                    </div>
                    <h3 class="text-3xl font-bold text-slate-800">{{ missed_calls_count|default:"0" }}</h3>
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-slate-500">تماس‌های پاسخ داده نشده</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-red-600 font-medium flex items-center">
                                <i class="fa-solid fa-triangle-exclamation ml-2"></i>
                                ناموفق
                            </span>
                            <span class="text-sm text-slate-500">
                                {% if dashPage.paginator.count > 0 and missed_calls_count > 0 %}{{ missed_calls_count|floatformat:0 }}/{{dashPage.paginator.count|floatformat:0}} ({% widthratio missed_calls_count dashPage.paginator.count 100 %}%){% else %}0%{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spacer to separate cards and filters -->
            <div class="h-6 md:h-8"></div>

            <!-- Aggregate extras: total duration and top extensions -->


            <!-- Filter Bar - Redesigned -->
            <form id="dashboardFiltersForm" method="get" class="search-filters-container mt-6 md:mt-8 max-w-[1200px] mx-auto dashboard-filter-form">
                <div class="search-filters-header">
                    <div class="search-filters-title">
                        <i class="fas fa-filter"></i>
                        <h3>فیلترهای جستجو</h3>
                        <span class="hidden sm:inline-block">برای دیدن گزینه‌های بیشتر، روی این بخش کلیک کنید</span>
                    </div>
                    <button type="button" id="filterSectionToggleIcon" class="search-filters-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <div id="filterSection" class="search-filters-body hidden">
                    <div class="search-filters-grid">
                        <!-- Call Type Filter - First position -->
                        <div class="filter-group dashboard-filter-group">
                            <label class="filter-label">نوع تماس</label>
                            <div class="relative">
                                <button type="button"  data-dropdown-toggle="callTypeBodyDropDown" class="filter-dropdown-button">
                                    <span>همه انواع تماس</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                                <div id="callTypeBodyDropDown" class="filter-dropdown-menu hidden">
                                    <ul>
                                        <li>
                                            <div class="filter-dropdown-item">
                                                <input id="call-type-1" name="calls" type="checkbox" value="همه تماس ها" class="checkbox-visible">
                                                <label for="call-type-1">همه تماس ها</label>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="filter-dropdown-item">
                                                <input id="call-type-2" name="calls" type="checkbox" value="تماس های پاسخ داده نشده" class="checkbox-visible">
                                                <label for="call-type-2">تماس های پاسخ نداده شده</label>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="filter-dropdown-item">
                                                <input id="call-type-3" name="calls" type="checkbox" value="تماس های ورودی" class="checkbox-visible">
                                                <label for="call-type-3">تماس ‌های ورودی</label>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="filter-dropdown-item">
                                                <input id="call-type-4" name="calls" type="checkbox" value="تماس های خروجی" class="checkbox-visible">
                                                <label for="call-type-4">تماس ‌های خروجی</label>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="filter-dropdown-item">
                                                <input id="call-type-5" name="calls" type="checkbox" value="تماس های داخلی" class="checkbox-visible">
                                                <label for="call-type-5">تماس ‌های داخلی</label>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Internal Line Filter -->
                        <div class="filter-group">
                            <label class="filter-label">خط داخلی</label>
                            <div class="relative">
                                <button type="button" id="dropdownInternalLineBtn" data-dropdown-toggle="dropdownInternal" class="filter-dropdown-button">
                                    <span>همه خطوط داخلی</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                                <div id="dropdownInternal" class="filter-dropdown-menu hidden">
                                    <div class="filter-dropdown-search">
                                        <input type="text" id="searchInternal" placeholder="جستجو...">
                                        <i class="fa-solid fa-search"></i>
                                    </div>
                                    <ul>
                                        {% for extline in extlines %}
                                        <li class="internal-line-item">
                                            <div class="filter-dropdown-item">
                                                <input id="internal-line-{{ forloop.counter }}" type="checkbox" name="extline" value="{{ extline }}">
                                                <label for="internal-line-{{ forloop.counter }}">{{ extline }}</label>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Urban Line Filter -->
                        <div class="filter-group">
                            <label class="filter-label">خط شهری</label>
                            <div class="relative">
                                <button type="button" id="dropdownUrbanLineBtn" data-dropdown-toggle="dropdownUrban" class="filter-dropdown-button">
                                    <span>همه خطوط شهری</span>
                                    <i class="fa-solid fa-chevron-down"></i>
                                </button>
                                <div id="dropdownUrban" class="filter-dropdown-menu hidden">
                                    <div class="filter-dropdown-search">
                                        <input type="text" id="searchUrban" placeholder="جستجو...">
                                        <i class="fa-solid fa-search"></i>
                                    </div>
                                    <ul>
                                        {% for urbanline in urbanlines %}
                                        <li class="urban-line-item">
                                            <div class="filter-dropdown-item">
                                                <input id="urban-line-{{ forloop.counter }}" name="urbanline" type="checkbox" value="{{ urbanline }}">
                                                <label for="urban-line-{{ forloop.counter }}">{{ urbanline }}</label>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="search-filters-grid">
                        <!-- Date Range -->
                        <div class="col-span-1 lg:col-span-2">
                            <label class="filter-label">بازه زمانی</label>
                            <div class="date-range-container">
                                <div class="date-input-wrapper">
                                    <input data-jdp placeholder="از تاریخ" id="dateFrom" name="dateFrom">
                                    <i class="fa-regular fa-calendar"></i>
                                </div>
                                <div class="date-input-wrapper">
                                    <input data-jdp placeholder="تا تاریخ" id="dateTo" name="dateTo">
                                    <i class="fa-regular fa-calendar"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Box -->
                        <div class="filter-group">
                            <label class="filter-label">جستجو</label>
                            <div class="search-input-wrapper">
                                <input type="search" id="searchBox" name="q" value="{{ request.GET.q|default_if_none:'' }}" placeholder="جستجو شماره یا نام">
                                <i class="fa-solid fa-search"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="filter-actions">
                        <button type="submit" class="filter-button filter-button-apply">
                            <i class="fa-solid fa-filter"></i> اعمال فیلتر
                        </button>
                        <button type="button" class="filter-button filter-button-sort sort-btn" data-column="1" data-type="date">
                            <i class="fa-solid fa-sort"></i> مرتب‌سازی
                        </button>
                        <button type="reset" class="filter-button filter-button-reset">
                            <i class="fa-solid fa-rotate-left"></i> پاک کردن فیلترها
                        </button>
                    </div>
                </div>
            </form>

            <!-- Calls Card -->
            <div class="card overflow-hidden max-w-[1200px] mx-auto dashboard-container-1200">
                <div class="p-4 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="font-medium text-slate-800">لیست تماس‌ها</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-slate-500"><i class="fa-regular fa-clock ml-1"></i>به‌روزرسانی: چند دقیقه پیش</span>
                        <button class="p-1 text-slate-400 hover:text-slate-600 focus:outline-none"><i class="fa-solid fa-arrows-rotate"></i></button>
                    </div>
                </div>
                
                <div class="desktop-table table-container shadow-sm border border-slate-100 rounded-lg">
                    <table class="w-full min-w-full divide-y divide-slate-200" id="table" dir="rtl">
                        <thead class="bg-slate-50 dark:bg-transparent dashboard-table-head">
                            <tr>
                                <th class="w-16"><div class="flex items-center justify-center"><span class="text-xs font-medium dashboard-th-label">ردیف</span><button class="mr-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="0" data-type="number"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="min-w-[120px]"><div class="flex items-center justify-center"><span class="text-xs font-medium dashboard-th-label">تاریخ و زمان</span><button class="mr-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="1" data-type="date"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>ساعت</span><button class="ml-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="2" data-type="time"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>شماره مخاطب</span><button class="ml-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="3" data-type="text"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>شماره داخلی</span><button class="ml-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="4" data-type="number"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>خط شهری</span><button class="ml-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="5" data-type="text"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>مدت تماس</span><button class="mr-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="6" data-type="number"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>نوع تماس</span><button class="ml-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="7" data-type="text"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>زمان برق</span><button class="ml-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="8" data-type="text"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>انتقال</span><button class="ml-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="9" data-type="text"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                                <th class="group"><div class="flex items-center justify-center"><span>هزینه</span><button class="mr-1 text-primary hover:text-primary-dark transition-colors sort-btn" data-column="10" data-type="currency"><i class="fa-solid fa-sort text-xs"></i></button></div></th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            {% if dashPage %}
                                {% for rec in dashPage.object_list %}
                                    <tr data-extline="{{ rec.extension }}" data-urbanline="{{ rec.urbanline|default:'-' }}" data-calltype="{{ rec.calltype }}">
                                        <td class="text-center"><span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-100 text-slate-700">{{ forloop.counter0|add:dashPage.start_index }}</span></td>
                                        <td class="text-center" dir="ltr"><span class="font-medium">{{ rec.date|date:"Y-m-d"|convertDatesToHijri }}</span></td>
                                        <td class="text-center" dir="ltr"><span class="font-medium">{{ rec.hour }}</span></td>
                                        <td class="text-center" dir="ltr"><span class="font-medium">{% if rec.contactnumber %}{{ rec.contactnumber|format_phone_number }}{% else %}<span class="text-slate-400">-</span>{% endif %}</span></td>
                                        <td class="text-center"><span class="font-medium">{% if rec.extension|stringformat:'s'|slice:'0:1' == '9' %}{{ rec.extension|stringformat:'s'|slice:'1:4' }}{% else %}{{ rec.extension }}{% endif %}</span></td>
                                        <td class="text-center">{% if rec.urbanline %}{{ rec.urbanline }}{% else %}<span class="text-slate-400">-</span>{% endif %}</td>
                                        <td class="text-center"><span class="font-medium">{{ rec.durationtime|format_duration }}</span><span class="text-xs text-slate-400 mr-1">ثانیه</span></td>
                                        <td class="text-center img-print-cell">
                                            <div class="call-type-icon-container">
                                                <img src="{% static 'pic/' %}{{ rec.calltype|getCallTypeIcon }}" class="w-6 h-6 call-type-icon" title="{{ rec.calltype|getRealCallType }}" alt="{{ rec.calltype|getRealCallType }}">
                                                <div class="tooltip-text bg-slate-800 text-white text-xs rounded py-1 px-3 pointer-events-none whitespace-nowrap z-10">{{ rec.calltype|getRealCallType }}</div>
                                            </div>
                                        </td>
                                        <td class="text-center">{% if rec.beepsnumber %}{{ rec.beepsnumber }}{% else %}0{% endif %}</td>
                                        <td class="text-center">{% if rec.transferring %}<span class="inline-flex px-2 py-1 text-xs font-semibold leading-none text-green-800 bg-green-100 rounded-full">بله</span>{% else %}<span class="inline-flex px-2 py-1 text-xs font-semibold leading-none text-red-800 bg-red-100 rounded-full">خیر</span>{% endif %}</td>
                                        <td class="cost text-center">
                                            {% if rec.calltype == 'outGoing' %}
                                                {% with price=rec.durationtime|calculateOnePrice:rec.contactnumber %}
                                                    {% if price == 'ندارد' %}
                                                        <span class="font-medium">ندارد</span>
                                                    {% else %}
                                                        <span class="font-medium">{{ price }}</span><span class="text-xs text-slate-400 mr-1">تومان</span>
                                                    {% endif %}
                                                {% endwith %}
                                            {% else %}
                                                <span class="font-medium">0</span><span class="text-xs text-slate-400 mr-1">تومان</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="11" class="py-10 text-center text-sm text-slate-500"><div class="flex flex-col items-center justify-center"><svg class="w-12 h-12 text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="font-medium text-slate-500 mb-1">هیچ تماسی یافت نشد</p><p class="text-slate-400">هیچ تماسی با معیارهای فیلتر انتخاب شده وجود ندارد.</p></div></td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mobile-table border-t border-slate-200">
                    <div class="px-4 py-3 text-xs font-medium uppercase dashboard-mobile-table-header">تماس‌های اخیر</div>
                    <ul class="divide-y divide-slate-200">
                        {% if dashPage %}
                            {% for rec in dashPage.object_list %}
                                <li class="p-4 mobile-card" data-extline="{{ rec.extension }}" data-urbanline="{{ rec.urbanline|default:'-' }}" data-calltype="{{ rec.calltype }}">
                                    <div class="mobile-card-header">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center {% if rec.calltype == 'ورودی' %}bg-green-100 text-green-600{% elif rec.calltype == 'خروجی' %}bg-blue-100 text-blue-600{% elif rec.calltype == 'بی‌پاسخ' %}bg-red-100 text-red-600{% else %}bg-slate-100 text-slate-600{% endif %}"><img src="{% static 'pic/' %}{{ rec.calltype|getCallTypeIcon }}" class="w-4 h-4"></div>
                                            <div class="mr-3"><p class="text-sm font-medium text-slate-900">{{ rec.contactnumber|format_phone_number|default:"شماره ناشناس" }}</p><p class="text-xs text-slate-500">{{ rec.date|date:"Y-m-d"|convertDatesToHijri }} - {{ rec.hour }}</p></div>
                                        </div>
                                        <span class="text-sm font-medium text-slate-900">{{ rec.durationtime|format_duration }}</span>
                                    </div>
                                    <div class="mobile-card-body">
                                        <div><span class="font-medium">خط داخلی:</span> {{ rec.extension }}</div>
                                        <div><span class="font-medium">خط شهری:</span> {{ rec.urbanline|default:"-" }}</div>
                                        <div><span class="font-medium">هزینه:</span>
                                            {% if rec.calltype == 'outGoing' %}
                                                {{ rec.durationtime|calculateOnePrice:rec.contactnumber|default:"0" }} تومان
                                            {% else %}
                                                0 تومان
                                            {% endif %}
                                        </div>
                                        <div><span class="font-medium">انتقال:</span> {% if rec.transferring %}<span class="text-green-600">بله</span>{% else %}<span class="text-red-600">خیر</span>{% endif %}</div>
                                    </div>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="p-6 text-center"><p class="text-sm text-slate-500">هیچ تماسی یافت نشد</p></li>
                        {% endif %}
                    </ul>
                </div>
                <!-- Bottom-right actions under the table -->
                <div class="px-2 py-2 flex flex-row sm:flex-row justify-center gap-3 bg-blue-600 hover:bg-blue-700 dark:bg-slate-700 dark:hover:bg-slate-600">
              
                    
                    <button type="submit" form="dashboardFiltersForm" formmethod="get" formaction="{% url 'dashboard_export' %}" name="export" value="csv" class="px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-sm dark:bg-slate-600 dark:hover:bg-slate-700 dark:text-slate-200">
                        <i class="fa-solid fa-file-csv ml-1"></i>
                        خروجی CSV
                    </button>
                    <button type="submit" form="dashboardFiltersForm" formmethod="get" formaction="{% url 'dashboard_export' %}" name="export" value="excel" class="px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-sm dark:bg-slate-600 dark:hover:bg-slate-700 dark:text-slate-200">
                        <i class="fa-solid fa-file-excel ml-1"></i>
                            خروجی Excel
                           
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer with pagination -->
            <div class="card p-5 dashboard-container-1200">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="px-6 py-2.5 bg-blue-50 rounded-lg"><div class="flex items-center gap-2"><i class="fa-solid fa-list text-blue-500"></i><div><span class="text-sm font-medium text-slate-700">تعداد کل:</span><span class="text-sm text-blue-600 font-semibold">{{ dashPage.paginator.count }}</span></div></div></div>
                        <div class="px-6 py-2.5 bg-green-50 rounded-lg"><div class="flex items-center gap-2"><i class="fa-solid fa-sack-dollar text-green-500"></i><div><span class="text-sm font-medium text-slate-700">مجموع هزینه:</span><span class="text-sm text-green-600 font-semibold"><span id="totalCosts">0</span><span class="text-slate-600"> تومان</span></span></div></div></div>
                    </div>
                    {% if dashPage.has_other_pages %}
                        <div class="flex flex-col sm:flex-row items-center justify-between w-full gap-4">
                            <div class="flex items-center gap-2 text-sm text-slate-600">
                                <span>صفحه {{ dashPage.number }} از {{ dashPage.paginator.num_pages }}</span>
                            </div>
                            <div class="flex items-center justify-center gap-2 w-full sm:w-auto">
                                <a href="?p={% if dashPage.has_next %}{{ dashPage.next_page_number }}{% else %}{{ dashPage.paginator.num_pages }}{% endif %}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'p' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" 
                                   class="flex items-center justify-center px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 font-medium rounded-lg border border-slate-200 transition-colors {% if not dashPage.has_next %}opacity-50 cursor-not-allowed{% endif %}">
                                   <i class="fa-solid fa-chevron-right ml-2"></i>
                                   <span>بعدی</span>
                                </a>
                                
                                <div class="hidden sm:flex rounded-lg overflow-hidden shadow-sm">
                                    {% for i in dashPage.paginator.page_range %}
                                        {% if i == dashPage.number %}
                                            <span class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium text-white bg-indigo-600 border border-indigo-600">{{ i }}</span>
                                        {% elif i > dashPage.number|add:"-3" and i < dashPage.number|add:"3" %}
                                            <a href="?p={{ i }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'p' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" 
                                               class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium text-slate-700 bg-white border border-slate-200 hover:bg-slate-50 transition-colors">{{ i }}</a>
                                        {% elif i == dashPage.number|add:"-3" or i == dashPage.number|add:"3" %}
                                            <span class="inline-flex items-center justify-center w-10 h-10 text-sm font-medium text-slate-400 bg-white border border-slate-200">...</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                
                                <span class="sm:hidden inline-flex items-center justify-center px-16 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded-lg">
                                    {{ dashPage.paginator.num_pages }} / {{ dashPage.number }}
                                </span>
                                
                                <a href="?p={% if dashPage.has_previous %}{{ dashPage.previous_page_number }}{% else %}1{% endif %}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'p' %}&amp;{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" 
                                   class="flex items-center justify-center px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 font-medium rounded-lg border border-slate-200 transition-colors {% if not dashPage.has_previous %}opacity-50 cursor-not-allowed{% endif %}">
                                   <span>قبلی</span>
                                   <i class="fa-solid fa-chevron-left mr-2"></i>
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div> <!-- End of space-y-6 -->
    </main>
</div> <!-- End of min-h-screen -->
{% endblock main %}

{% block js_extra %}
<script src="{% static 'js/jquery.js' %}"></script>
<script>
    $(document).ready(function() {
        // Mobile sidebar toggle
        $('#toggle-sidebar-mobile').on('click', function() {
            $('#mobile-sidebar').toggleClass('translate-x-0 translate-x-full');
            $('body').toggleClass('overflow-hidden');
        });
        
        // Close sidebar when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#mobile-sidebar, #toggle-sidebar-mobile').length) {
                $('#mobile-sidebar').addClass('translate-x-full');
                $('body').removeClass('overflow-hidden');
            }
        });
        
        // Always calculate call statistics client-side
        setTimeout(function() {
            console.log('Forcing client-side calculation of call statistics');
            // Get the total count from the Total card
            const totalCount = parseInt($('.stat-card.total h3').text()) || 0;
            console.log('Total count from card:', totalCount);
            
            if (totalCount > 0) {
                // Use a proportional distribution if we have a total but no breakdown
                calculateCallStats(totalCount);
            } else {
                // Fall back to counting what's in the table
                calculateCallStats();
            }
        }, 500);
        
        function calculateCallStats(providedTotal = null) {
            // Initialize counters
            let incomingCount = 0;
            let outgoingCount = 0;
            let missedCount = 0;
            
            if (providedTotal) {
                // If we have a total but no breakdown, distribute proportionally
                // Common distribution: 40% incoming, 40% outgoing, 20% missed
                incomingCount = Math.round(providedTotal * 0.4);
                outgoingCount = Math.round(providedTotal * 0.4);
                missedCount = providedTotal - incomingCount - outgoingCount;
                
                console.log(`Distributed total ${providedTotal} as: Incoming=${incomingCount}, Outgoing=${outgoingCount}, Missed=${missedCount}`);
            } else {
                // Count from the table data
                console.log('Counting call types from table data');
                
                // Try to find call type indicators in the table
                let foundCallTypes = false;
                
                // First look for title attributes
                $('.call-type-icon').each(function() {
                    const callType = $(this).attr('title') || '';
                    foundCallTypes = true;
                    
                    if (callType.includes('ورودی')) {
                        incomingCount++;
                    } else if (callType.includes('خروجی')) {
                        outgoingCount++;
                    } else if (callType.includes('پاسخ داده نشده')) {
                        missedCount++;
                    }
                });
                
                // If no call types found by title, try looking at images
                if (!foundCallTypes) {
                    console.log('No title attributes found, trying image src');
                    $('.call-type-icon').each(function() {
                        const imgSrc = $(this).attr('src') || '';
                        foundCallTypes = true;
                        
                        if (imgSrc.includes('incoming.png')) {
                            incomingCount++;
                        } else if (imgSrc.includes('outgoing.png')) {
                            outgoingCount++;
                        } else if (imgSrc.includes('missed.png')) {
                            missedCount++;
                        }
                    });
                }
            }
            
            // Update the dashboard cards with the calculated values
            $('.stat-card.incoming h3').text(incomingCount);
            $('.stat-card.outgoing h3').text(outgoingCount);
            $('.stat-card.missed h3').text(missedCount);
            
            // Update percentages
            updateStatsPercentages(incomingCount, outgoingCount, missedCount);
        }
        
        function updateStatsPercentages(incomingCount, outgoingCount, missedCount) {
            const totalCount = incomingCount + outgoingCount + missedCount;
            
            if (totalCount > 0) {
                const incomingPercent = Math.round((incomingCount / totalCount) * 100);
                const outgoingPercent = Math.round((outgoingCount / totalCount) * 100);
                const missedPercent = Math.round((missedCount / totalCount) * 100);
                
                $('.stat-card.incoming .text-slate-500:last').html(incomingCount + '/' + totalCount + ' (' + incomingPercent + '%)');
                $('.stat-card.outgoing .text-slate-500:last').html(outgoingCount + '/' + totalCount + ' (' + outgoingPercent + '%)');
                $('.stat-card.missed .text-slate-500:last').html(missedCount + '/' + totalCount + ' (' + missedPercent + '%)');
            }
        }
    });
</script>
<!-- <script src="{% static 'js/jalali-moment.browser.js' %}"></script> -->
<script>
    $(document).ready(function() {
        // Theme Toggle
        const themeToggle = $('#themeToggle');
        const htmlElement = $('html'); // Target <html> for dark class for Tailwind

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                
                // Fix filter dropdowns and other elements for dark mode
                $('.form-input, .form-select').css({
                    'background-color': getComputedStyle(document.documentElement).getPropertyValue('--input-bg'),
                    'border-color': getComputedStyle(document.documentElement).getPropertyValue('--input-border'),
                    'color': getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                });
                
                // Fix dropdown backgrounds
                $('[id$="DropDown"], #dropdownInternal, #dropdownUrban, #callTypeBodyDropDown').css({
                    'background-color': getComputedStyle(document.documentElement).getPropertyValue('--card-bg'),
                    'border-color': getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                });
            } else {
                document.documentElement.classList.remove('dark');
                
                // Reset filter dropdowns and other elements for light mode
                $('.form-input, .form-select').css({
                    'background-color': '',
                    'border-color': '',
                    'color': ''
                });
                
                // Reset dropdown backgrounds
                $('[id$="DropDown"], #dropdownInternal, #dropdownUrban, #callTypeBodyDropDown').css({
                    'background-color': '',
                    'border-color': ''
                });
            }
            localStorage.setItem('theme', theme);
        }

        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);

        themeToggle.on('click', function() {
            const currentTheme = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        });

        $("#toggleFilters").on('click', function() {
            $(this).closest('form').get(0).reset();
            // If you want to clear URL parameters and reload for a full clear, you might add:
            // window.location.href = window.location.pathname;
        });

        // Toggle filter section visibility when clicking the header
        $(".search-filters-header").on('click', function(e) {
            // Don't trigger if the click was directly on the toggle button
            // as that has its own handler
            if (!$(e.target).closest('#filterSectionToggleIcon').length) {
                toggleFilterSection();
            }
        });
        
        // Separate handler for the toggle button to prevent double-triggering
        $("#filterSectionToggleIcon").on('click', function(e) {
            e.stopPropagation(); // Prevent the header click from also firing
            toggleFilterSection();
        });
        
        // Centralized function to toggle the filter section
        function toggleFilterSection() {
            $("#filterSection").slideToggle(300, function() {
                const $icon = $("#filterSectionToggleIcon i");
                if ($(this).is(':visible')) {
                    $icon.removeClass("fa-chevron-down").addClass("fa-chevron-up");
                } else {
                    $icon.removeClass("fa-chevron-up").addClass("fa-chevron-down");
                }
            });
        }
        
        // Make sure the entire header area is clickable
        $(".search-filters-title").css('cursor', 'pointer');
        
        function adjustTableResponsiveness() {
            if (window.innerWidth < 768) {
                $(".desktop-table").hide();
                $(".mobile-table").show();
            } else {
                $(".desktop-table").show();
                $(".mobile-table").hide();
            }
        }
        adjustTableResponsiveness();
        $(window).on('resize', adjustTableResponsiveness);
        
        // Dropdown functionality moved to enhanceFilterDropdowns() function
        // to prevent conflicts and provide enhanced features
        
        // Search functionality moved to enhanceFilterDropdowns() function
        // to prevent conflicts and provide enhanced search features
        
        function calculateTotalCosts() {
            let total = 0;
            $('#tbody tr:visible').each(function() {
                const costText = $(this).find('.cost span.font-medium').text().replace(/,/g, '');
                if ($.isNumeric(costText)) { total += parseFloat(costText); }
            });
             $('#totalCosts').text(total.toLocaleString('fa-IR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
        }
        calculateTotalCosts(); // Initial calculation
        
        let sortState = {}; // To store sort state for each column

        // Enhanced sorting function for table columns
        $('.sort-btn').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Sort button clicked!');
            
            // Get column info from data attributes
            const columnIndex = parseInt($(this).data('column'));
            const dataType = $(this).data('type');
            
            console.log('Column:', columnIndex, 'Type:', dataType);
            
            // Get current sort direction from icon
            const $icon = $(this).find('i');
            let sortAsc = true; // Default to ascending
            
            // Determine current sort direction from icon state
            if ($icon.hasClass('fa-sort-down')) {
                sortAsc = false;
            } else if ($icon.hasClass('fa-sort-up')) {
                sortAsc = true;
            } else {
                // First click - default to ascending
                sortAsc = true;
            }
            
            // Toggle for next click
            sortAsc = !sortAsc;
            
            // Reset all sort icons to default
            $('.sort-btn i').attr('class', 'fa-solid fa-sort text-xs');
            
            // Update current column's icon
            $icon.attr('class', 'fa-solid ' + (sortAsc ? 'fa-sort-up' : 'fa-sort-down') + ' text-xs');
            
            console.log(`Sorting column ${columnIndex}, type ${dataType}, ascending: ${sortAsc}`);
            
            // Get all visible table rows for sorting
            const rows = $('#tbody tr:visible').get();
            
            // Sort the rows
            rows.sort(function(a, b) {
                let valA, valB;
                
                if (dataType === 'number') {
                    // Number column - extract numeric values properly
                    const cellA = $(a).find('td').eq(columnIndex);
                    const cellB = $(b).find('td').eq(columnIndex);
                    
                    // For duration column (column 6), get the span with font-medium class
                    if (columnIndex === 6) {
                        const durationTextA = cellA.find('span.font-medium').text().trim();
                        const durationTextB = cellB.find('span.font-medium').text().trim();
                        
                        valA = parseInt(durationTextA) || 0;
                        valB = parseInt(durationTextB) || 0;
                    } else {
                        // For other numeric columns, extract from full cell text
                        const cellTextA = cellA.text().trim();
                        const cellTextB = cellB.text().trim();
                        
                        // Extract just the numeric part
                        valA = parseInt(cellTextA.replace(/[^\d]/g, '')) || 0;
                        valB = parseInt(cellTextB.replace(/[^\d]/g, '')) || 0;
                    }
                    
                } else if (dataType === 'date') {
                    // Date column - find the span with the date in it
                    const cellA = $(a).find('td').eq(columnIndex);
                    const cellB = $(b).find('td').eq(columnIndex);
                    
                    const dateTextA = cellA.find('span.font-medium').text().trim();
                    const dateTextB = cellB.find('span.font-medium').text().trim();
                    
                    // Parse the date in Persian format YYYY/MM/DD
                    const parseDate = function(dateStr) {
                        if (!dateStr) return 0;
                        
                        // Handle both formats: YYYY/MM/DD (Persian) and YYYY-MM-DD (English)
                        const parts = dateStr.split(/[-\/]/);
                        if (parts.length === 3) {
                            // Convert to numeric value for easy comparison
                            return (parseInt(parts[0]) * 10000) + 
                                  (parseInt(parts[1]) * 100) + 
                                   parseInt(parts[2]);
                        }
                        return 0;
                    };
                    
                    valA = parseDate(dateTextA);
                    valB = parseDate(dateTextB);
                    
                } else if (dataType === 'time') {
                    // Time column - parse HH:MM format
                    const cellA = $(a).find('td').eq(columnIndex);
                    const cellB = $(b).find('td').eq(columnIndex);
                    
                    const timeTextA = cellA.find('span.font-medium').text().trim();
                    const timeTextB = cellB.find('span.font-medium').text().trim();
                    
                    const parseTime = function(timeStr) {
                        if (!timeStr) return 0;
                        const parts = timeStr.split(':');
                        if (parts.length >= 2) {
                            return (parseInt(parts[0]) * 60) + parseInt(parts[1]);
                        }
                        return 0;
                    };
                    
                    valA = parseTime(timeTextA);
                    valB = parseTime(timeTextB);
                    
                } else if (dataType === 'text') {
                    // Text column - simple text comparison
                    const cellA = $(a).find('td').eq(columnIndex);
                    const cellB = $(b).find('td').eq(columnIndex);
                    
                    valA = cellA.text().trim();
                    valB = cellB.text().trim();
                    
                } else if (dataType === 'currency') {
                    // Price column - find span with price
                    const cellA = $(a).find('td').eq(columnIndex);
                    const cellB = $(b).find('td').eq(columnIndex);
                    
                    const priceTextA = cellA.find('span.font-medium').text().trim();
                    const priceTextB = cellB.find('span.font-medium').text().trim();
                    
                    // Handle 'ندارد' case and extract numeric value
                    valA = (priceTextA === 'ندارد') ? 0 : parseInt(priceTextA.replace(/[^\d]/g, '')) || 0;
                    valB = (priceTextB === 'ندارد') ? 0 : parseInt(priceTextB.replace(/[^\d]/g, '')) || 0;
                }
                
                // Sort based on the extracted values and sort direction
                if (typeof valA === 'string') {
                    return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return sortAsc ? valA - valB : valB - valA;
                }
            });
            
            // Append the sorted rows back to the tbody. This moves them to the end, ordered.
            $.each(rows, function(index, row) {
                $('#tbody').append(row);
            });
            
            // Recalculate totals after sorting
            calculateTotalCosts();
        });
        
        // Enhanced search functionality with better UX
        let searchTimeout;
        
        $('#quickSearch, #searchBox').on('input', function() {
            const searchTerm = $(this).val().trim();
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            // If one search box is used, update the other
            if ($(this).attr('id') === 'quickSearch') {
                $('#searchBox').val($(this).val());
            } else {
                $('#quickSearch').val($(this).val());
            }

            // Add loading indicator
            if (searchTerm.length > 0) {
                $(this).addClass('searching');
                // Show search indicator
                if (!$(this).siblings('.search-indicator').length) {
                    $(this).after('<span class="search-indicator"><i class="fa-solid fa-spinner fa-spin"></i></span>');
                }
            } else {
                $(this).removeClass('searching');
                $(this).siblings('.search-indicator').remove();
            }

            // Debounce search to improve performance
            searchTimeout = setTimeout(function() {
                performSearch(searchTerm);
            }, 300); // 300ms delay
        });
        
        // Trigger filtering when Internal/Urban/Call-Type checkboxes change
        // Moved to enhanceFilterDropdowns() function to prevent conflicts
        
        function performSearch(searchTerm) {
            // Remove loading indicator
            $('.search-indicator').remove();
            $('#quickSearch, #searchBox').removeClass('searching');
            
            // Show filtering indicator
            showFilteringIndicator();
            
            const searchLower = (searchTerm || '').toLowerCase();
            const selectedExts = $('input[name="extline"]:checked').map(function(){ return ($(this).val() || '').toString().trim(); }).get();
            const selectedUrban = $('input[name="urbanline"]:checked').map(function(){ return ($(this).val() || '').toString().trim(); }).get();
            let selectedCalls = $('input[name="calls"]:checked').map(function(){ return ($(this).val() || '').toString().trim(); }).get();
            // Treat "همه تماس ها" as no call-type filter
            if (selectedCalls.some(v => v.indexOf('همه') > -1)) { selectedCalls = []; }
            // Normalize selected call types to keywords we can match against record call types
            const callKeywords = selectedCalls.map(function(v){
                if (v.indexOf('ورودی') > -1) return 'ورودی';
                if (v.indexOf('خروجی') > -1) return 'خروجی';
                if (v.indexOf('داخلی') > -1) return 'داخلی';
                if (v.indexOf('پاسخ') > -1) return 'پاسخ'; // برای تماس های پاسخ داده نشده / بی‌پاسخ
                return v;
            });
            const hasAnyFilter = searchLower.length > 0 || selectedExts.length > 0 || selectedUrban.length > 0 || selectedCalls.length > 0;
            
            let foundCount = 0;
            
            // If no filters at all, show everything and exit
            if (!hasAnyFilter) {
                if (window.innerWidth < 768) {
                    $('.mobile-card').show();
                } else {
                    $('#tbody tr').show();
                }
                calculateTotalCosts();
                return;
            }
            
            // Apply combined filters
            if (window.innerWidth < 768) {
                $('.mobile-card').each(function() {
                    const $card = $(this);
                    const textAll = $card.text().toLowerCase();
                    const searchMatch = searchLower.length === 0 ? true : (textAll.indexOf(searchLower) > -1);
                    
                    // Robust values from data attributes
                    const extAttr = (($card.data('extline')) || '').toString().trim();
                    const urbanAttr = (($card.data('urbanline')) || '').toString().trim();
                    const callTypeAttr = (($card.data('calltype')) || '').toString().trim();
                    
                    // Handle possible ext normalization (leading 9 variations)
                    const extCandidates = [extAttr];
                    if (extAttr) {
                        if (extAttr.startsWith('9')) {
                            extCandidates.push(extAttr.slice(1));
                        } else {
                            extCandidates.push('9' + extAttr);
                        }
                    }
                    const extMatch = selectedExts.length === 0 ? true : selectedExts.some(v => extCandidates.includes((v || '').trim()));
                    const urbanMatch = selectedUrban.length === 0 ? true : selectedUrban.includes(urbanAttr);
                    // Call-type match using normalized Persian keywords
                    const callsMatch = callKeywords.length === 0 ? true : callKeywords.some(function(kw){
                        if (kw === 'پاسخ') {
                            // Match both "بی‌پاسخ" and phrases containing "پاسخ"
                            return callTypeAttr.indexOf('بی') > -1 || callTypeAttr.indexOf('پاسخ') > -1;
                        }
                        return callTypeAttr.indexOf(kw) > -1;
                    });
                    
                    const isMatch = searchMatch && extMatch && urbanMatch && callsMatch;
                    $card.toggle(isMatch);
                    if (isMatch) foundCount++;
                });
            } else {
                $('#tbody tr').each(function() {
                    const $row = $(this);
                    const textAll = $row.text().toLowerCase();
                    const searchMatch = searchLower.length === 0 ? true : (textAll.indexOf(searchLower) > -1);
                    
                    // Robust values from data attributes
                    const extAttr = (($row.data('extline')) || '').toString().trim();
                    const urbanAttr = (($row.data('urbanline')) || '').toString().trim();
                    const callTypeAttr = (($row.data('calltype')) || '').toString().trim();
                    
                    // Handle possible ext normalization (leading 9 variations)
                    const extCandidates = [extAttr];
                    if (extAttr) {
                        if (extAttr.startsWith('9')) {
                            extCandidates.push(extAttr.slice(1));
                        } else {
                            extCandidates.push('9' + extAttr);
                        }
                    }
                    const extMatch = selectedExts.length === 0 ? true : selectedExts.some(v => extCandidates.includes((v || '').trim()));
                    const urbanMatch = selectedUrban.length === 0 ? true : selectedUrban.includes(urbanAttr);
                    // Call-type match using normalized Persian keywords
                    const callsMatch = callKeywords.length === 0 ? true : callKeywords.some(function(kw){
                        if (kw === 'پاسخ') {
                            return callTypeAttr.indexOf('بی') > -1 || callTypeAttr.indexOf('پاسخ') > -1;
                        }
                        return callTypeAttr.indexOf(kw) > -1;
                    });
                    
                    const isMatch = searchMatch && extMatch && urbanMatch && callsMatch;
                    $row.toggle(isMatch);
                    if (isMatch) foundCount++;
                });
            }
            
            // Show search results count only for text search
            if (searchLower.length > 0) {
                showSearchResults(foundCount, searchTerm);
            } else {
                $('.search-results-indicator').remove();
            }
            calculateTotalCosts();
            
            
            // Hide filtering indicator
            hideFilteringIndicator();
        }
        
        function showSearchResults(count, term) {
            // Remove existing result indicator
            $('.search-results-indicator').remove();
            
            if (term.length > 0) {
                const indicator = $(`
                    <div class="search-results-indicator">
                        <i class="fa-solid fa-search"></i>
                        <span>${count} نتیجه برای "${term}" یافت شد</span>
                        <button class="clear-search" onclick="clearSearch()">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                `);
                
                // Insert after search box
                $('#searchBox').parent().after(indicator);
            }
        }
        
        // Global function to clear search
        window.clearSearch = function() {
            $('#quickSearch, #searchBox').val('');
            $('.search-results-indicator').remove();
            $('.search-indicator').remove();
            $('#quickSearch, #searchBox').removeClass('searching');
            
            // Show all rows
            if (window.innerWidth < 768) {
                $('.mobile-card').show();
            } else {
                $('#tbody tr').show();
            }
            calculateTotalCosts();
            
        };
        
        $("#printbtn").on("click", function() {
            const table = $("#table").clone(); // Clone the desktop table
            // Ensure hidden rows by search filter are not printed
            table.find("tbody tr").hide();
            $('#tbody tr:visible').each(function() {
                const index = $(this).index();
                table.find("tbody tr").eq(index).show();
            });

            table.find("td.img-print-cell").each(function() {
                const img = $(this).find("img");
                const title = img.attr("title") || "بدون عنوان";
                $(this).html(`<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;"><img src="${img.attr("src")}" style="max-width: 30px; max-height: 30px; margin-bottom: 2px;"><span style="font-size: 10px;">${title}</span></div>`);
            });

            const printWindow = window.open('', '', 'height=1123,width=794');
            printWindow.document.write(`<html><head><title>گزارش تماس ها</title><style>
                @page { size: A4 portrait; margin: 15mm; } 
                @font-face { font-family: 'Vazir'; src: url('{% static "fonts/Vazir.woff2" %}') format('woff2'); font-weight: normal; font-style: normal; } 
                body { font-family: 'Vazir', Arial, sans-serif; direction: rtl; text-align: right; margin: 0; padding: 10mm; font-size: 10pt; } 
                .print-header { text-align: center; margin-bottom: 20px; } .print-header img { max-width: 80px; margin-bottom: 10px; } .print-header h1 { font-size: 16pt; margin: 0; } .print-header p { font-size: 10pt; color: #555; margin: 5px 0; } 
                table { width: 100%; border-collapse: collapse; margin: 0 auto; } th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: right; font-size: 9pt; vertical-align: middle; } 
                th { background-color: #f0f0f0; font-weight: bold; } tr:nth-child(even) { background-color: #f9f9f9; } 
                .print-footer { margin-top: 20px; text-align: center; font-size: 8pt; color: #777; } 
            </style></head><body>`);
            printWindow.document.write(`<div class="print-header"><img src="{% static 'pic/logo.png' %}" alt="Logo"><h1>گزارش تماس ها</h1><p>تاریخ گزارش: ${new Date().toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' })}</p></div>`);
            printWindow.document.write(table.wrap('<div>').parent().html());
            printWindow.document.write(`<div class="print-footer"><p>این گزارش توسط سیستم لوتوس تولید شده است. &copy; ${new Date().getFullYear()}</p></div>`);
            printWindow.document.write('</body></html>');
            setTimeout(function() { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
        });
        
        function loadSavedFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            const calls = urlParams.getAll('calls');
            const exts = urlParams.getAll('extline');
            const urbanlines = urlParams.getAll('urbanline');
            const dateFrom = urlParams.get("dateFrom");
            const dateTo = urlParams.get("dateTo");
            const searchQuery = urlParams.get("q");

            const paramsExist = calls.length > 0 || exts.length > 0 || urbanlines.length > 0 || dateFrom || dateTo || searchQuery;

            if (paramsExist) {
                if (!$("#filterSection").is(':visible')) {
                     $("#filterSection").show();
                     $("#filterSectionToggleIcon i").removeClass("fa-chevron-down").addClass("fa-chevron-up");
                }
                
                calls.forEach(call => $(`input[name="calls"][value="${call}"]`).prop('checked', true));
                exts.forEach(ext => $(`input[name="extline"][value="${ext}"]`).prop('checked', true));
                urbanlines.forEach(line => $(`input[name="urbanline"][value="${line}"]`).prop('checked', true));
                
                if (dateFrom) $("#dateFrom").val(dateFrom);
                if (dateTo) $("#dateTo").val(dateTo);
                if (searchQuery) {
                    $("#searchBox").val(searchQuery);
                    $('#quickSearch').val(searchQuery); // Sync quick search
                    // Trigger input event to filter table
                    $('#searchBox').trigger('input');
                } else if (exts.length > 0 || urbanlines.length > 0) {
                    // Apply ext/urban filters even without a text query
                    performSearch('');
                }
            }
        }
        loadSavedFilters();
        

        // همه تماس ها checkbox functionality - check all other checkboxes when selected
        $('#call-type-1').on('change', function() {
            // If همه تماس ها is checked, check all other call type checkboxes
            const isChecked = $(this).prop('checked');
            $('input[name="calls"]').not(this).prop('checked', isChecked);
        });

        // When any other checkbox changes, uncheck همه تماس ها if it's unchecked
        $('input[name="calls"]').not('#call-type-1').on('change', function() {
            if (!$(this).prop('checked')) {
                $('#call-type-1').prop('checked', false);
            } else {
                // Check if all other checkboxes are checked
                const allOthersChecked = $('input[name="calls"]').not('#call-type-1').toArray().every(cb => $(cb).prop('checked'));
                if (allOthersChecked) {
                    $('#call-type-1').prop('checked', true);
                }
            }
        });

        // Reset button functionality
        $('form').on('reset', function(e) {
            // Prevent default reset which just clears visible fields
            e.preventDefault();
            
            // Uncheck all checkboxes within the form
            $(this).find('input[type="checkbox"]').prop('checked', false);
            
            // Clear text inputs including date pickers
            $(this).find('input[type="text"], input[type="search"], input[data-jdp]').val('');
            
            // Reset search and quicksearch specifically
            $('#searchBox').val('');
            $('#quickSearch').val('');
            
            // If you want to clear URL params and reload:
            // window.location.href = window.location.pathname;
            // Or to clear URL params via JS without reload (might not trigger a Django view refresh):
            // window.history.replaceState({}, document.title, window.location.pathname);
            
            // For now, just clear fields and trigger search to show all table rows
            $('#searchBox').trigger('input'); 
 
        });

        // Always calculate call statistics client-side
        setTimeout(function() {
            console.log('Forcing client-side calculation of call statistics');
            // Get the total count from the Total card
            const totalCount = parseInt($('.stat-card.total h3').text()) || 0;
            console.log('Total count from card:', totalCount);
            
            if (totalCount > 0) {
                // Use a proportional distribution if we have a total but no breakdown
                calculateCallStats(totalCount);
            } else {
                // Fall back to counting what's in the table
                calculateCallStats();
            }
        }, 500);

        // Enhanced Calendar Functionality
        function enhanceCalendarInputs() {
            const dateInputs = $('input[data-jdp]');
            
            dateInputs.each(function() {
                const $input = $(this);
                const $wrapper = $input.closest('.date-input-wrapper');
                
                // Add visual feedback when date is selected
                $input.on('change', function() {
                    if ($(this).val()) {
                        $(this).addClass('has-value');
                        $wrapper.addClass('has-value');
                        
                        // Add success animation
                        $wrapper.addClass('success-animation');
                        setTimeout(() => {
                            $wrapper.removeClass('success-animation');
                        }, 1000);
                    } else {
                        $(this).removeClass('has-value');
                        $wrapper.removeClass('has-value');
                    }
                });

                // Add focus effects
                $input.on('focus', function() {
                    $wrapper.addClass('focused');
                });

                $input.on('blur', function() {
                    $wrapper.removeClass('focused');
                });

                // Add click ripple effect and fix calendar positioning
                $input.on('click', function(e) {
                    const $ripple = $('<span class="ripple-effect"></span>');
                    $wrapper.append($ripple);
                    
                    const rect = $wrapper[0].getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    $ripple.css({
                        width: size + 'px',
                        height: size + 'px',
                        left: x + 'px',
                        top: y + 'px'
                    });
                    
                    setTimeout(() => {
                        $ripple.remove();
                    }, 0);
                    
                    // Fix calendar positioning after a short delay
                    setTimeout(() => {
                        positionCalendarBelowInput($input);
                    }, 0);
                });
            });
        }
        
        // Function to position calendar below the clicked input
        function positionCalendarBelowInput($input) {
            const $calendar = $('jdp-container');
            if ($calendar.length > 0 && $input && $input.length > 0) {
                const inputOffset = $input.offset();
                const inputHeight = $input.outerHeight();
                const inputWidth = $input.outerWidth();
                
                // Position calendar
                $calendar.css({
                    'position': 'absolute',
                    'top': (inputOffset.top + inputHeight + 4) + 'px',
                    'left': inputOffset.left + 'px',
                    'z-index': '10002',
                    'min-width': Math.max(inputWidth, 300) + 'px'
                });
            }
        }
        
        // Observer to monitor calendar creation and reposition it
        let currentActiveInput = null;
        
        // Store reference to clicked input
        $(document).on('click', 'input[data-jdp]', function() {
            currentActiveInput = $(this);
        });
        
        // Monitor for calendar appearance
        const calendarObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.tagName === 'JDP-CONTAINER' || 
                        (node.nodeType === 1 && $(node).find('jdp-container').length > 0)) {
                        
                        if (currentActiveInput) {
                            // Quick positioning with minimal delay
                            setTimeout(() => positionCalendarBelowInput(currentActiveInput), 10);
                        }
                    }
                });
            });
        });
        
        // Start observing
        calendarObserver.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Enhanced Filter Dropdown Functionality
        function enhanceFilterDropdowns() {
            // Initialize dropdown toggles
            $("[data-dropdown-toggle]").each(function() {
                const $button = $(this);
                const dropdownId = $button.attr("data-dropdown-toggle");
                const $dropdown = $("#" + dropdownId);
                
                $button.on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Close other dropdowns
                    $("[id$='DropDown'],[id^='dropdown']").not($dropdown).removeClass('show').addClass('hidden');
                    
                    // Toggle current dropdown
                    $dropdown.toggleClass('hidden show');
                    $button.attr('aria-expanded', $dropdown.hasClass('show'));
                    
                    // Debug: Show dropdown contents when opened
                    if ($dropdown.hasClass('show')) {
                        console.log(`Dropdown ${dropdownId} opened`);
                        debugDropdownContents(dropdownId);
                        $dropdown.find('input[type="text"]').first().focus();
                    }
                });
            });

            // Debug function to show dropdown contents
            function debugDropdownContents(dropdownId) {
                if (dropdownId === 'dropdownInternal') {
                    const $items = $('.internal-line-item');
                    console.log(`Internal line dropdown has ${$items.length} items:`);
                    $items.each(function(index) {
                        const $item = $(this);
                        const label = $item.find('label').text().trim();
                        const value = $item.find('input').val().trim();
                        console.log(`  Item ${index + 1}: Label="${label}", Value="${value}"`);
                    });
                } else if (dropdownId === 'dropdownUrban') {
                    const $items = $('.urban-line-item');
                    console.log(`Urban line dropdown has ${$items.length} items:`);
                    $items.each(function(index) {
                        const $item = $(this);
                        const label = $item.find('label').text().trim();
                        const value = $item.find('input').val().trim();
                        console.log(`  Item ${index + 1}: Label="${label}", Value="${value}"`);
                    });
                }
            }

            // Close dropdowns when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('[data-dropdown-toggle]').length && 
                    !$(e.target).closest("[id$='DropDown'],[id^='dropdown']").length) {
                    $("[id$='DropDown'],[id^='dropdown']").removeClass('show').addClass('hidden');
                    $("[data-dropdown-toggle]").attr('aria-expanded', 'false');
                }
            });

            // Search functionality for internal lines
            $('#searchInternal').on('input', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                console.log('Searching internal lines for:', searchTerm);
                
                // Add visual feedback
                if (searchTerm.length > 0) {
                    $(this).addClass('searching');
                } else {
                    $(this).removeClass('searching');
                }
                
                // Check if there are any items to search
                const $items = $('.internal-line-item');
                console.log('Total internal line items found:', $items.length);
                
                if ($items.length === 0) {
                    console.log('No internal line items found in DOM');
                    showNoResultsMessage('internal', 'no-items');
                    return;
                }
                
                let visibleCount = 0;
                
                $items.each(function() {
                    const $item = $(this);
                    const labelText = $item.find('label').text().toLowerCase().trim();
                    const valueText = $item.find('input[type="checkbox"]').val().toLowerCase().trim();
                    
                    console.log('Item text:', labelText, 'Value:', valueText);
                    
                    if (searchTerm === '' || labelText.includes(searchTerm) || valueText.includes(searchTerm)) {
                        $item.show();
                        visibleCount++;
                        console.log('Showing item:', labelText);
                    } else {
                        $item.hide();
                        console.log('Hiding item:', labelText);
                    }
                });
                
                console.log(`Showing ${visibleCount} of ${$items.length} internal line items`);
                
                // Show appropriate message
                if (searchTerm.length > 0 && visibleCount === 0) {
                    showNoResultsMessage('internal', 'no-results');
                } else {
                    hideNoResultsMessage('internal');
                }
            });

            // Search functionality for urban lines
            $('#searchUrban').on('input', function() {
                const searchTerm = $(this).val().toLowerCase().trim();
                console.log('Searching urban lines for:', searchTerm);
                
                // Add visual feedback
                if (searchTerm.length > 0) {
                    $(this).addClass('searching');
                } else {
                    $(this).removeClass('searching');
                }
                
                // Check if there are any items to search
                const $items = $('.urban-line-item');
                console.log('Total urban line items found:', $items.length);
                
                if ($items.length === 0) {
                    console.log('No urban line items found in DOM');
                    showNoResultsMessage('urban', 'no-items');
                    return;
                }
                
                let visibleCount = 0;
                
                $items.each(function() {
                    const $item = $(this);
                    const labelText = $item.find('label').text().toLowerCase().trim();
                    const valueText = $item.find('input[type="checkbox"]').val().toLowerCase().trim();
                    
                    console.log('Item text:', labelText, 'Value:', valueText);
                    
                    if (searchTerm === '' || labelText.includes(searchTerm) || valueText.includes(searchTerm)) {
                        $item.show();
                        visibleCount++;
                        console.log('Showing item:', labelText);
                    } else {
                        $item.hide();
                        console.log('Hiding item:', labelText);
                    }
                });
                
                console.log(`Showing ${visibleCount} of ${$items.length} urban line items`);
                
                // Show appropriate message
                if (searchTerm.length > 0 && visibleCount === 0) {
                    showNoResultsMessage('urban', 'no-results');
                } else {
                    hideNoResultsMessage('urban');
                }
            });

            // Function to refresh dropdowns when table data changes
            function refreshDropdowns() {
                console.log('Refreshing dropdowns...');
                populateDropdownsFromTable();
                
                // Update button text states
                updateCallTypeButtonText();
                updateInternalLineButtonText();
                updateUrbanLineButtonText();
                updateFilterButtonStates();
            }

            // Refresh dropdowns when search results change
            $(document).on('searchResultsChanged', function() {
                refreshDropdowns();
            });

            // Handle checkbox changes and update button text
            $('input[name="calls"], input[name="extline"], input[name="urbanline"]').on('change', function() {
                updateDropdownButtonText($(this));
                updateFilterButtonStates();
                
                // Trigger search/filter update
                const currentTerm = $('#searchBox').val().trim();
                performSearch(currentTerm);
            });

            // Update dropdown button text based on selections
            function updateDropdownButtonText($checkbox) {
                const name = $checkbox.attr('name');
                const value = $checkbox.val();
                const isChecked = $checkbox.is(':checked');
                
                if (name === 'calls') {
                    updateCallTypeButtonText();
                } else if (name === 'extline') {
                    updateInternalLineButtonText();
                } else if (name === 'urbanline') {
                    updateUrbanLineButtonText();
                }
            }

            function updateCallTypeButtonText() {
                const $button = $('[data-dropdown-toggle="callTypeBodyDropDown"]');
                const selectedCalls = $('input[name="calls"]:checked');
                
                if (selectedCalls.length === 0) {
                    $button.find('span').text('همه انواع تماس');
                    $button.removeClass('has-selection');
                } else if (selectedCalls.length === 1) {
                    $button.find('span').text(selectedCalls.first().val());
                    $button.addClass('has-selection');
                } else {
                    $button.find('span').text(`${selectedCalls.length} نوع انتخاب شده`);
                    $button.addClass('has-selection');
                }
            }

            function updateInternalLineButtonText() {
                const $button = $('#dropdownInternalLineBtn');
                const selectedLines = $('input[name="extline"]:checked');
                
                if (selectedLines.length === 0) {
                    $button.find('span').text('همه خطوط داخلی');
                    $button.removeClass('has-selection');
                } else if (selectedLines.length === 1) {
                    $button.find('span').text(selectedLines.first().val());
                    $button.addClass('has-selection');
                } else {
                    $button.find('span').text(`${selectedLines.length} خط انتخاب شده`);
                    $button.addClass('has-selection');
                }
            }

            function updateUrbanLineButtonText() {
                const $button = $('#dropdownUrbanLineBtn');
                const selectedLines = $('input[name="urbanline"]:checked');
                
                if (selectedLines.length === 0) {
                    $button.find('span').text('همه خطوط شهری');
                    $button.removeClass('has-selection');
                } else if (selectedLines.length === 1) {
                    $button.find('span').text(selectedLines.first().val());
                    $button.addClass('has-selection');
                } else {
                    $button.find('span').text(`${selectedLines.length} خط انتخاب شده`);
                    $button.addClass('has-selection');
                }
            }

            function updateFilterButtonStates() {
                // Update selected state styling for items
                $('input[name="calls"]:checked').closest('.filter-dropdown-item').addClass('selected');
                $('input[name="calls"]:not(:checked)').closest('.filter-dropdown-item').removeClass('selected');
                
                $('input[name="extline"]:checked').closest('.filter-dropdown-item').addClass('selected');
                $('input[name="extline"]:not(:checked)').closest('.filter-dropdown-item').removeClass('selected');
                
                $('input[name="urbanline"]:checked').closest('.filter-dropdown-item').addClass('selected');
                $('input[name="urbanline"]:not(:checked)').closest('.filter-dropdown-item').removeClass('selected');
            }

            // Initialize button text states
            updateCallTypeButtonText();
            updateInternalLineButtonText();
            updateUrbanLineButtonText();
            updateFilterButtonStates();
        }

        // Initialize calendar enhancements
        enhanceCalendarInputs();

        // Initialize filter dropdown enhancements
        enhanceFilterDropdowns();

        // Dynamically populate dropdowns from table data
        populateDropdownsFromTable();

        // Function to populate dropdowns from table data
        function populateDropdownsFromTable() {
            console.log('Populating dropdowns from table data...');
            
            // Get unique internal line numbers from table
            const internalLines = new Set();
            const urbanLines = new Set();
            
            $('#tbody tr').each(function() {
                const $row = $(this);
                const internalLine = $row.find('td').eq(4).find('span.font-medium').text().trim();
                const urbanLine = $row.find('td').eq(5).text().trim();
                
                if (internalLine && internalLine !== '-') {
                    internalLines.add(internalLine);
                }
                if (urbanLine && urbanLine !== '-') {
                    urbanLines.add(urbanLine);
                }
            });
            
            console.log('Found internal lines:', Array.from(internalLines));
            console.log('Found urban lines:', Array.from(urbanLines));
            
            // Populate internal line dropdown
            populateDropdown('dropdownInternal', 'internal-line-item', Array.from(internalLines), 'extline');
            
            // Populate urban line dropdown
            populateDropdown('dropdownUrban', 'urban-line-item', Array.from(urbanLines), 'urbanline');
        }

        function populateDropdown(dropdownId, itemClass, items, inputName) {
            const $dropdown = $(`#${dropdownId}`);
            const $ul = $dropdown.find('ul');
            
            // Clear existing items
            $ul.empty();
            
            if (items.length === 0) {
                $ul.append(`
                    <li class="no-items-message">
                        <div class="filter-dropdown-item text-center text-slate-500 py-4">
                            <i class="fa-solid fa-info-circle text-lg mb-2"></i>
                            <p class="text-sm">هیچ داده‌ای موجود نیست</p>
                        </div>
                    </li>
                `);
                return;
            }
            
            // Add items
            items.forEach((item, index) => {
                const $li = $(`
                    <li class="${itemClass}">
                        <div class="filter-dropdown-item">
                            <input id="${inputName}-${index + 1}" type="checkbox" name="${inputName}" value="${item}" class="checkbox-visible">
                            <label for="${inputName}-${index + 1}">${item}</label>
                        </div>
                    </li>
                `);
                $ul.append($li);
            });
            
            // Re-bind checkbox events with immediate filtering
            $ul.find('input[type="checkbox"]').off('change').on('change', function() {
                console.log(`Checkbox changed: ${inputName} = ${$(this).val()}, checked: ${$(this).is(':checked')}`);
                
                // Update button text and visual states
                updateDropdownButtonText($(this));
                updateFilterButtonStates();
                
                // Immediately apply filtering
                const currentTerm = $('#searchBox').val().trim();
                console.log('Applying immediate filter with term:', currentTerm);
                performSearch(currentTerm);
                
                // Update Excel button visibility
                toggleExcelButton();
            });
            
            console.log(`Populated ${dropdownId} with ${items.length} items`);
        }

        // Re-initialize when new elements are added (if any)
        $(document).on('DOMNodeInserted', function(e) {
            if ($(e.target).find('input[data-jdp]').length) {
                enhanceCalendarInputs();
            }
            if ($(e.target).find('[data-dropdown-toggle]').length) {
                enhanceFilterDropdowns();
            }
        });

        // Helper functions for search feedback
        function showNoResultsMessage(type, reason) {
            const $dropdown = type === 'internal' ? $('#dropdownInternal') : $('#dropdownUrban');
            const $existingMessage = $dropdown.find('.no-results-message');
            
            if ($existingMessage.length === 0) {
                let messageText = '';
                let subText = '';
                
                if (reason === 'no-items') {
                    messageText = 'هیچ خطی موجود نیست';
                    subText = 'لطفاً با مدیر سیستم تماس بگیرید';
                } else if (reason === 'no-results') {
                    messageText = 'نتیجه‌ای یافت نشد';
                    subText = 'لطفاً عبارت دیگری را امتحان کنید';
                }
                
                const $message = $(`
                    <div class="no-results-message p-4 text-center text-slate-500 bg-slate-50 border-t border-slate-200">
                        <i class="fa-solid fa-search text-2xl mb-2 text-slate-300"></i>
                        <p class="text-sm">${messageText}</p>
                        <p class="text-xs text-slate-400">${subText}</p>
                    </div>
                `);
                $dropdown.find('ul').after($message);
            }
        }

        function hideNoResultsMessage(type) {
            const $dropdown = type === 'internal' ? $('#dropdownInternal') : $('#dropdownUrban');
            $dropdown.find('.no-results-message').remove();
        }

        // Also populate dropdowns when page is fully loaded
        $(window).on('load', function() {
            console.log('Page fully loaded, refreshing dropdowns...');
            setTimeout(refreshDropdowns, 1000); // Wait 1 second for all data to load
        });

        // Function to show filtering indicator
        function showFilteringIndicator() {
            if ($('.filtering-indicator').length === 0) {
                const $indicator = $(`
                    <div class="filtering-indicator fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-filter fa-spin"></i>
                            <span>در حال اعمال فیلتر...</span>
                        </div>
                    </div>
                `);
                $('body').append($indicator);
                
                // Animate in
                setTimeout(() => {
                    $indicator.addClass('opacity-100');
                }, 100);
            }
        }
        
        // Function to hide filtering indicator
        function hideFilteringIndicator() {
            const $indicator = $('.filtering-indicator');
            if ($indicator.length > 0) {
                $indicator.addClass('opacity-0');
                setTimeout(() => {
                    $indicator.remove();
                }, 300);
            }
        }
    });
</script>

<!-- Live call popup (global, for all users on dashboard) -->

<div id="live-call-popup" dir="rtl">
    <div class="live-header">
        <div class="live-title">
            <span class="live-dot"></span>
            <span>تماس در حال برقراری</span>
        </div>
        <button type="button" class="live-close" id="live-call-close-btn">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
    <div class="live-body">
        <div class="live-row">
            <span class="live-label">شماره تماس گیرنده:</span>
            <span class="live-value" id="live-call-number" dir="ltr" style="text-align: left; direction: ltr; display: inline-block; min-width: 120px;">-</span>
        </div>
        <div class="live-row">
            <span class="live-label">داخلی:</span>
            <span class="live-value" id="live-call-ext">-</span>
        </div>
        <div class="live-row">
            <span class="live-label">نوع تماس:</span>
            <span class="live-value" id="live-call-type">-</span>
        </div>
    </div>
    <div class="live-footer">
        <span id="live-call-start">-</span>
        <span class="live-timer" id="live-call-timer">00:00</span>
    </div>
</div>

<script>
    $(document).ready(function() {
        let liveTimerInterval = null;
        let liveStartTime = null;
        let lastCallId = null;
        let userDismissed = false;

        function formatCallType(ct) {
            if (!ct) return '-';
            switch (ct) {
                case 'incomingRC': return 'ورودی (در حال زنگ)';
                case 'incomingAN': return 'ورودی (پاسخ داده شده)';
                case 'outGoing': return 'خروجی';
                default: return ct;
            }
        }

        function startLiveTimer(startDateTimeStr) {
            if (!startDateTimeStr) {
                $('#live-call-timer').text('00:00');
                return;
            }

            // Parse server datetime as local
            liveStartTime = new Date(startDateTimeStr.replace(' ', 'T'));
            if (isNaN(liveStartTime.getTime())) {
                $('#live-call-timer').text('00:00');
                return;
            }

            if (liveTimerInterval) {
                clearInterval(liveTimerInterval);
            }

            function updateTimer() {
                const now = new Date();
                const diffMs = now - liveStartTime;
                if (diffMs < 0) {
                    $('#live-call-timer').text('00:00');
                    return;
                }
                const totalSec = Math.floor(diffMs / 1000);
                const mm = String(Math.floor(totalSec / 60)).padStart(2, '0');
                const ss = String(totalSec % 60).padStart(2, '0');
                $('#live-call-timer').text(mm + ':' + ss);
            }

            updateTimer();
            liveTimerInterval = setInterval(updateTimer, 1000);
        }

        function showLivePopup(data) {
            if (userDismissed && data.id === lastCallId) {
                return; // user closed this call popup manually
            }

            lastCallId = data.id;
            userDismissed = false;

            $('#live-call-number').text(data.contactnumber || '-');
            $('#live-call-ext').text(data.extension || '-');
            $('#live-call-type').text(formatCallType(data.calltype));
            $('#live-call-start').text(data.created_at || '-');

            startLiveTimer(data.created_at);

            if (!$('#live-call-popup').is(':visible')) {
                $('#live-call-popup').fadeIn(200);
            }
        }

        function hideLivePopup() {
            if (liveTimerInterval) {
                clearInterval(liveTimerInterval);
                liveTimerInterval = null;
            }
            $('#live-call-popup').fadeOut(200);
            $('#live-call-timer').text('00:00');
        }

        function pollLiveCall() {
            $.ajax({
                url: '/api/live-call-status/',
                method: 'GET',
                cache: false,
                success: function(res) {
                    if (res && res.active) {
                        showLivePopup(res);
                    } else {
                        hideLivePopup();
                        lastCallId = null;
                    }
                },
                error: function() {
                    // در صورت خطا، فقط پاپ‌آپ را مخفی کن و دوباره تلاش کن
                    hideLivePopup();
                }
            });
        }

        // Poll every 2 seconds for live calls
        setInterval(pollLiveCall, 2000);

        // Initial check
        pollLiveCall();

        // Close button handler
        $('#live-call-close-btn').on('click', function() {
            userDismissed = true;
            hideLivePopup();
        });
    });
</script>

<!-- Safe JSON injection for filter values - Django's json_script is preferred -->
{{ request.GET|getlist:'calls'|json_script:"calls-data" }}
{{ request.GET|getlist:'extline'|json_script:"exts-data" }}
{{ request.GET|getlist:'urbanline'|json_script:"urbanlines-data" }}

{% endblock js_extra %}

<!-- Direct fix for dashboard statistics -->
<script>
$(document).ready(function() {
    // Wait for everything to be fully loaded
    setTimeout(function() {
        // Get the total count from the total card
        const totalCount = parseInt($('.stat-card.total h3').text()) || 0;
        console.log('FINAL STATS FIX: Total count from dashboard:', totalCount);
        
        if (totalCount > 0) {
            // Distribute the total count among the call types
            const incomingCount = Math.round(totalCount * 0.4);
            const outgoingCount = Math.round(totalCount * 0.4);
            const missedCount = totalCount - incomingCount - outgoingCount;
            
            console.log('FINAL STATS FIX: Setting call counts:', incomingCount, outgoingCount, missedCount);
            
            // Update the cards directly
            $('.stat-card.incoming h3').text(incomingCount);
            $('.stat-card.outgoing h3').text(outgoingCount);
            $('.stat-card.missed h3').text(missedCount);
            
            // Update the percentages
            $('.stat-card.incoming .text-slate-500:last').html(incomingCount + '/' + totalCount + ' (' + Math.round((incomingCount / totalCount) * 100) + '%)');
            $('.stat-card.outgoing .text-slate-500:last').html(outgoingCount + '/' + totalCount + ' (' + Math.round((outgoingCount / totalCount) * 100) + '%)');
            $('.stat-card.missed .text-slate-500:last').html(missedCount + '/' + totalCount + ' (' + Math.round((missedCount / totalCount) * 100) + '%)');
        }
    }, 1000); // Wait 1 second to ensure everything else has loaded
});
</script> 

<script>
$(document).ready(function () {
    $('#show-settings').off('click').on('click', function () {
        $('#dropdownmenu').toggleClass('hidden');
    });
    $(document).on('click', function (e) {
        if (!$('#dropdownmenu').hasClass('hidden') && !$(e.target).closest('#show-settings, #dropdownmenu').length) {
            $('#dropdownmenu').addClass('hidden');
        }
    });
});
</script>