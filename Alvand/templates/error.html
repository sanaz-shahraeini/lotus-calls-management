{% extends 'base.html' %}
{% load static %}
{% load errortags %}

{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
{# Uses app.css from base.html #}
<link rel="stylesheet" href="{% static 'css/pages/error.css' %}" type="text/css">
{% endblock %}

{% block main %}

<div class="my-0 w-full">
    <div class="w-full h-auto mt-1 mx-auto flex flex-col rtl">
        <div class="filter-section">
            <div class="filter-controls-single-line">
                <!-- Compact form elements -->
                <form id="filterForm" method="get" class="error-filter-form-inline">
                    <input id="dateFrom" data-jdp placeholder="از تاریخ" name="dateFrom" class="input-field-compact"
                        value="{{ request.GET.dateFrom|default:'' }}" />
                    <input id="dateTo" data-jdp placeholder="تا تاریخ" name="dateTo" class="input-field-compact"
                        value="{{ request.GET.dateTo|default:'' }}" />
                    <input type="search" id="search" name="search" placeholder="شماره خطا"
                        class="input-field-compact search-compact error-search-input-emphasis" value="{{ request.GET.search|default:'' }}" />
                    <button type="submit" id="applyFilterBtn" class="btn-compact btn-primary">
                        <i class="fas fa-filter"></i>
                        فیلتر
                    </button>
                </form>
                    
                <button id="up" class="sort-btn-compact">
                    <i class="fa-regular fa-arrow-up"></i>
                </button>

                {% if pages %}
                <div class="pagination-compact">
                    <a href="{% if pages.has_next %}?p={{ pages.next_page_number }}{% if request.GET.dateFrom %}&dateFrom={{ request.GET.dateFrom }}{% endif %}{% if request.GET.dateTo %}&dateTo={{ request.GET.dateTo }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% else %}#{% endif %}"
                        class="nav-btn {% if not pages.has_next %}disabled{% endif %}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <span class="page-info">{{ pages.number }}/{{ pages.paginator.num_pages }}</span>
                    <a href="{% if pages.has_previous %}?p={{ pages.previous_page_number }}{% if request.GET.dateFrom %}&dateFrom={{ request.GET.dateFrom }}{% endif %}{% if request.GET.dateTo %}&dateTo={{ request.GET.dateTo }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% else %}#{% endif %}"
                        class="nav-btn {% if not pages.has_previous %}disabled{% endif %}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </div>
                {% endif %}
                
                <form method="get" action="{% url 'error_export' %}">
                    {% if request.GET.dateFrom %}
                        <input type="hidden" name="dateFrom" value="{{ request.GET.dateFrom }}">
                    {% endif %}
                    {% if request.GET.dateTo %}
                        <input type="hidden" name="dateTo" value="{{ request.GET.dateTo }}">
                    {% endif %}
                    {% if request.GET.search %}
                        <input type="hidden" name="search" value="{{ request.GET.search }}">
                    {% endif %}
                    <input type="hidden" name="format" value="excel">
                    <button type="submit" class="excel-btn-compact">
                        <i class="fas fa-file-excel"></i>
                        دانلود اکسل 
                    </button>
                </form>
                <form method="get" action="{% url 'error_export' %}">
                    {% if request.GET.dateFrom %}
                        <input type="hidden" name="dateFrom" value="{{ request.GET.dateFrom }}">
                    {% endif %}
                    {% if request.GET.dateTo %}
                        <input type="hidden" name="dateTo" value="{{ request.GET.dateTo }}">
                    {% endif %}
                    {% if request.GET.search %}
                        <input type="hidden" name="search" value="{{ request.GET.search }}">
                    {% endif %}
                    <input type="hidden" name="format" value="csv">
                    <button type="submit" class="excel-btn-compact">
                        <i class="fas fa-file-csv"></i>
                        دانلود CSV
                    </button>
                </form>
            </div>
        </div>

        <div class="table-container">
            <table id='table' class="table-modern">
                <thead>
                    <tr>
                        <th>ردیف</th>
                        <th>تاریخ</th>
                        <th>ساعت</th>
                        <th>شماره خطا</th>
                        <th>عنوان خطا</th>
                        <th>علت احتمالی</th>
                        <th>راه حل پیشنهادی</th>
                    </tr>
                </thead>
                <tbody id="errorsTable">
                    {% if pages %}
                    {% for fault in pages.object_list %}
                    <tr>
                        <td data-label="ردیف">{{ forloop.counter0|add:pages.start_index }}</td>
                        <td data-label="تاریخ">{{ fault.persian_date|default:"تاریخ نامشخص" }}</td>
                        <td data-label="ساعت">{{ fault.persian_time|default:"زمان نامشخص" }}</td>
                        <td data-label="شماره خطا">{{ fault.errorcode }}</td>
                        <td data-label="عنوان خطا" class="text-cell text-center" data-type="errormessage" data-content="{{ fault.errormessage|default:'عنوان خطا مشخص نیست'|escape }}" data-code="{{ fault.errorcode|escape }}" title="کلیک کنید تا عنوان کامل خطا را مشاهده کنید">
                            <span class="clean-text">{{ fault.errormessage|default:"مشخص نیست" }}</span>
                        </td>
                        <td data-label="علت احتمالی" class="text-cell text-center" data-type="probablecause" data-content="{{ fault.probablecause|default:'علت احتمالی مشخص نیست'|escape }}" data-code="{{ fault.errorcode|escape }}" title="کلیک کنید تا علت کامل را مشاهده کنید">
                            <span class="clean-text">{{ fault.probablecause|default:"مشخص نیست" }}</span>
                        </td>
                        <td data-label="راه حل پیشنهادی" class="text-cell" data-type="solution" data-content="{{ fault.solution|default:'راه حل پیشنهادی موجود نیست'|escape }}" data-code="{{ fault.errorcode|escape }}" title="کلیک کنید تا راه حل کامل را مشاهده کنید">
                            <span class="clean-text">{{ fault.solution|default:"موجود نیست" }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal for displaying full text -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">جزئیات خطا</h3>
            <span class="close" onclick="closeModal()"></span>
        </div>
        <div class="modal-body">
            <div class="modal-sections-grid">
                <div class="modal-section">
                    <h4 class="modal-section-title">عنوان خطا</h4>
                    <div class="modal-section-content" id="modalErrorMessage">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
                <div class="modal-section">
                    <h4 class="modal-section-title">علت احتمالی</h4>
                    <div class="modal-section-content" id="modalProbableCause">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
                <div class="modal-section">
                    <h4 class="modal-section-title">راه حل پیشنهادی</h4>
                    <div class="modal-section-content" id="modalSolution">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="{% static 'js/jquery.js' %}"></script>
<script>
    $(document).ready(function () {
        // Check if jalaliDatepicker is available (it should be loaded from base.html)
        if (typeof jalaliDatepicker !== 'undefined') {
            console.log('Jalali Datepicker library loaded successfully');

            // Initialize date picker with proper format
            try {
                const datePickerOptions = {
                    minDate: "attr",
                    maxDate: "today",
                    hideAfterChange: true,
                    autoHide: true,
                    showTodayBtn: true,
                    showEmptyBtn: true,
                    persianDigits: true,
                    time: false,
                    format: 'YYYY/MM/DD',
                    autoClose: true,
                    topSpace: 10,
                    bottomSpace: 30,
                    dayRendering(opt, input) {
                        return {
                            isHollyDay: opt.day == 1
                        }
                    },
                    onSelect: function(formattedDate, dateObject, inputElement) {
                        if (inputElement) {
                            inputElement.value = formattedDate;
                        }
                    }
                };
                
                // Initialize date picker
                jalaliDatepicker.startWatch(datePickerOptions);
                console.log('Jalali Datepicker initialized successfully with format YYYY/MM/DD');
                
                // Add form submission handler
                $('form#filterForm').on('submit', function(e) {
                    const $dateFrom = $('#dateFrom');
                    const $dateTo = $('#dateTo');
                    
                    if ($dateFrom.val() && $dateTo.val()) {
                        try {
                            // Ensure dates are in YYYY/MM/DD format
                            const formatDate = (dateStr) => {
                                return dateStr.replace(/-/g, '/');
                            };
                            
                            $dateFrom.val(formatDate($dateFrom.val()));
                            $dateTo.val(formatDate($dateTo.val()));
                            
                        } catch (error) {
                            console.error('Error formatting dates:', error);
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing Jalali Datepicker:', error);
            }
        } else {
            console.error('Jalali Datepicker library not found - it should be loaded from base.html');

            // Try to load it manually if not available
            const script = document.createElement('script');
            script.src = "{% static 'dist/jalalidatepicker.js' %}";
            script.onload = function () {
                console.log('Jalali Datepicker loaded manually');
                const datePickerOptions = {
                    minDate: "attr",
                    maxDate: "today",
                    hideAfterChange: true,
                    autoHide: true,
                    showTodayBtn: true,
                    showEmptyBtn: true,
                    persianDigits: true,
                    time: false,
                    format: 'YYYY/MM/DD',
                    autoClose: true,
                    topSpace: 10,
                    bottomSpace: 30,
                    dayRendering(opt, input) {
                        return {
                            isHollyDay: opt.day == 1
                        }
                    },
                    onSelect: function(formattedDate, dateObject, inputElement) {
                        if (inputElement) {
                            inputElement.value = formattedDate;
                        }
                    }
                };
                
                jalaliDatepicker.startWatch(datePickerOptions);
                
                // Add form submission handler for fallback as well
                $('form#filterForm').on('submit', function(e) {
                    const $dateFrom = $('#dateFrom');
                    const $dateTo = $('#dateTo');
                    
                    if ($dateFrom.val() && $dateTo.val()) {
                        try {
                            const formatDate = (dateStr) => {
                                return dateStr.replace(/-/g, '/');
                            };
                            
                            $dateFrom.val(formatDate($dateFrom.val()));
                            $dateTo.val(formatDate($dateTo.val()));
                            
                        } catch (error) {
                            console.error('Error formatting dates (fallback):', error);
                        }
                    }
                });
            };
            document.head.appendChild(script);
        }
    });
</script>
<script>
    // Modal functions
    function showDetailModal(event, errorCode) {
        console.log('Opening modal for:', {errorCode});
        const modal = document.getElementById('detailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalErrorMessage = document.getElementById('modalErrorMessage');
        const modalProbableCause = document.getElementById('modalProbableCause');
        const modalSolution = document.getElementById('modalSolution');

        if (!modal) {
            console.error('Modal element not found!');
            return;
        }
        if (!modalTitle || !modalErrorMessage || !modalProbableCause || !modalSolution) {
            console.error('Modal content elements not found!');
            return;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : String(text);
            return div.innerHTML;
        }

        const safeCode = escapeHtml(errorCode);
        modalTitle.innerHTML = `خطای <span class="ltr">${safeCode}</span> - جزئیات`;

        // Get all row data from the clicked row
        const targetCell = event.target.closest('.text-cell');
        const row = targetCell ? targetCell.closest('tr') : null;
        const data = {
            errormessage: row ? row.querySelector('[data-type="errormessage"]')?.getAttribute('data-content') || 'محتوا موجود نیست' : 'محتوا موجود نیست',
            probablecause: row ? row.querySelector('[data-type="probablecause"]')?.getAttribute('data-content') || 'محتوا موجود نیست' : 'محتوا موجود نیست',
            solution: row ? row.querySelector('[data-type="solution"]')?.getAttribute('data-content') || 'محتوا موجود نیست' : 'محتوا موجود نیست'
        };

        modalErrorMessage.innerHTML = formatTextForModal(data.errormessage.replace(/\?/g, ''));
        modalProbableCause.innerHTML = formatTextForModal(data.probablecause.replace(/\?/g, ''));
        modalSolution.innerHTML = formatTextForModal(data.solution.replace(/\?/g, ''));

        // Show the modal
        modal.style.display = 'flex';
        void modal.offsetHeight;
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        console.log('Modal should be visible now');
    }

    // تابع برای فرمت کردن متن
    function formatTextForModal(text) {
        function wrapLtrTokens(value) {
            if (!value) return '';
            // If line is mostly English, wrap the whole line
            if (/^[A-Za-z0-9][\s\-_/().,:+]*[A-Za-z0-9]$/.test(String(value).trim())) {
                return `<span class="ltr">${value}</span>`;
            }
            // Otherwise wrap English tokens
            return String(value)
                .replace(/([A-Za-z0-9][A-Za-z0-9\s\-_/().,:+]*[A-Za-z0-9])/g, '<span class="ltr">$1</span>');
        }

        if (!text) {
            return '<p class="modal-empty-paragraph">محتوا موجود نیست</p>';
        }

        // ابتدا بر اساس خط جدید تقسیم کن تا هر خط به یک آیتم مستقل تبدیل شود
        let lines = String(text).split(/[\r\n]+/).map(l => l.trim()).filter(l => l.length > 0);

        // اگر فقط یک خط داشتیم، دوباره بر اساس نقطه/علامت تعجب/سؤال تقسیم کنیم
        if (lines.length <= 1) {
            lines = String(text).split(/[.!?]/).map(l => l.trim()).filter(l => l.length > 0);
        }

        // اگر باز هم فقط یک مورد بود، همان را در یک پاراگراف ساده برگردان
        if (lines.length <= 1) {
            const clean = lines[0] || String(text);
            return `<p class="modal-single-paragraph">${wrapLtrTokens(clean)}</p>`;
        }

        // تبدیل به لیست زیبا
        let formattedText = '<ul>';
        lines.forEach((item) => {
            let cleanSentence = item
                .replace(/^[,\.\s]+/, '')
                .replace(/[,\.\s]+$/, '');
            if (cleanSentence.length > 0) {
                formattedText += `<li>${wrapLtrTokens(cleanSentence)}</li>`;
            }
        });
        formattedText += '</ul>';

        return formattedText;
    }

    function closeModal() {
        const modal = document.getElementById('detailModal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            document.body.classList.remove('modal-open');
        }
    }
    
    // Initialize modal state and event listeners
    function initModal() {
        // Initialize modal
        const modal = document.getElementById('detailModal');
        if (!modal) {
            console.error('Modal element not found!');
            return;
        }
        
        // Hide modal initially
        modal.style.display = 'none';
        
        // Add close button handler
        const closeBtn = modal.querySelector('.close');
        if (closeBtn) {
            closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeModal();
            });
        }
        
        // Close modal when clicking outside content
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.classList.contains('show')) {
                closeModal();
            }
        });
    }
    
    // Initialize table cell click handlers
    function initTableClickHandlers() {
        // Add click handler for table cells using event delegation on the table container
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
            tableContainer.addEventListener('click', function(e) {
                const textCell = e.target.closest('.text-cell');
                if (textCell) {
                    e.preventDefault();
                    const code = textCell.getAttribute('data-code') || '';
                    showDetailModal(e, code);
                }
            });
        }
    }
    
    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initModal();
        initTableClickHandlers();
    });

    // Initialize table and search functionality when document is ready
    $(document).ready(function () {
        // Initialize variables
        let reversed = false;
        const $table = $("#table");
        const $searchInput = $("#search");
        const $tableBody = $("#errorsTable");
        const $filterForm = $("#filterForm");
        const $applyFilterBtn = $("#applyFilterBtn");
        let $tableRows = $table.find("tbody tr");
        let $originalTableRows = $table.find("tbody tr"); // Keep reference to all original rows
        let ajaxRequest = null; // Store current AJAX request for cancellation
        
        // Real-time filtering function using AJAX
        function performRealTimeFilter() {
            const searchValue = $("#search").val().trim();
            const dateFrom = $("#dateFrom").val();
            const dateTo = $("#dateTo").val();
            
            console.log("Real-time AJAX filtering with search:", searchValue);
            
            // Cancel previous AJAX request if it exists
            if (ajaxRequest) {
                ajaxRequest.abort();
            }
            
            // If search is empty and no date filters, don't make AJAX call
            if (!searchValue && !dateFrom && !dateTo) {
                console.log("No filters applied, skipping AJAX call");
                $searchInput.removeClass('search-state-loading search-state-success search-state-error').addClass('search-state-default');
                $searchInput.attr('title', 'جستجوی شماره خطا');
                return;
            }
            
            // Show loading indicator
            $searchInput.removeClass('search-state-default search-state-success search-state-error').addClass('search-state-loading');
            $searchInput.attr('title', 'در حال جستجو...');
            
            // Build URL parameters
            const params = {};
            if (searchValue) params.search = searchValue;
            if (dateFrom) params.dateFrom = dateFrom;
            if (dateTo) params.dateTo = dateTo;
            
            // Make AJAX request to search endpoint
            ajaxRequest = $.ajax({
                url: '{% url "error_search_ajax" %}',
                method: 'GET',
                data: params,
                dataType: 'json',
                success: function(response) {
                    console.log("AJAX search successful:", response);
                    
                    if (response.success) {
                        // Clear current table body
                        $tableBody.empty();
                        
                        // Populate table with results
                        if (response.results && response.results.length > 0) {
                            response.results.forEach(function(record) {
                                const row = `
                                    <tr>
                                        <td>${record.index}</td>
                                        <td>${record.persian_date}</td>
                                        <td>${record.persian_time}</td>
                                        <td>${record.errorcode}</td>
                                        <td class="text-cell text-center" data-type="errormessage" 
                                            data-content="${escapeHtml(record.errormessage)}" 
                                            data-code="${record.errorcode}" 
                                            title="کلیک کنید تا عنوان کامل خطا را مشاهده کنید">
                                            <span class="clean-text">${truncateText(record.errormessage, 50)}</span>
                                        </td>
                                        <td class="text-cell text-center" data-type="probablecause" 
                                            data-content="${escapeHtml(record.probablecause)}" 
                                            data-code="${record.errorcode}" 
                                            title="کلیک کنید تا علت کامل را مشاهده کنید">
                                            <span class="clean-text">${truncateText(record.probablecause, 50)}</span>
                                        </td>
                                        <td class="text-cell" data-type="solution" 
                                            data-content="${escapeHtml(record.solution)}" 
                                            data-code="${record.errorcode}" 
                                            title="کلیک کنید تا راه حل کامل را مشاهده کنید">
                                            <span class="clean-text">${truncateText(record.solution, 50)}</span>
                                        </td>
                                    </tr>
                                `;
                                $tableBody.append(row);
                            });
                            
                            // Update visible rows reference
                            $tableRows = $table.find("tbody tr");
                            $originalTableRows = $tableRows;
                            
                            // Update pagination info
                            updatePaginationInfo(response.count);
                            
                            // Success feedback
                            $searchInput.removeClass('search-state-default search-state-loading search-state-error').addClass('search-state-success');
                            $searchInput.attr('title', `${response.count} نتیجه پیدا شد`);
                        } else {
                            // No results found
                            $tableBody.html(`
                                <tr>
                                    <td colspan="7" class="no-results-cell">
                                        نتیجه‌ای یافت نشد
                                    </td>
                                </tr>
                            `);
                            
                            $searchInput.removeClass('search-state-default search-state-loading search-state-success').addClass('search-state-error');
                            $searchInput.attr('title', 'نتیجه‌ای یافت نشد');
                            
                            updatePaginationInfo(0);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    if (status !== 'abort') {
                        console.error("AJAX search error:", error);
                        $searchInput.removeClass('search-state-default search-state-loading search-state-success').addClass('search-state-error');
                        $searchInput.attr('title', 'خطا در جستجو');
                    }
                },
                complete: function() {
                    ajaxRequest = null;
                }
            });
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function to truncate text
        function truncateText(text, maxLength) {
            if (!text) return 'مشخص نیست';
            text = text.replace(/\?/g, '').replace(/\s+/g, ' ').trim();
            if (text.length > maxLength) {
                let truncated = text.substring(0, maxLength);
                let lastSpace = truncated.lastIndexOf(' ');
                if (lastSpace > maxLength * 0.7) {
                    truncated = truncated.substring(0, lastSpace);
                }
                return truncated;
            }
            return text;
        }
        
        // Debounced filtering function
        let filterTimeout;
        function debouncedFilter() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(performRealTimeFilter, 300); // 300ms delay
        }
        
        // Update pagination info based on visible rows
        function updatePaginationInfo(count) {
            const pageInfo = $('.page-info');
            if (pageInfo.length) {
                if (count !== undefined) {
                    pageInfo.text(`${count} نتیجه`);
                } else {
                    const visibleRows = $table.find("tbody tr:visible").length;
                    pageInfo.text(`${visibleRows} نتیجه`);
                }
            }
            
            // Hide pagination controls when filtering
            const paginationContainer = $('.pagination-compact');
            if (paginationContainer.length) {
                const searchValue = $("#search").val().trim();
                if (searchValue) {
                    // When filtering, hide pagination arrows
                    paginationContainer.find('.nav-btn').hide();
                    pageInfo.show();
                } else {
                    // When not filtering, show normal pagination
                    paginationContainer.find('.nav-btn').show();
                }
            }
        }
        
        // Handle filter form submission (for date filtering)
        $filterForm.on("submit", function(e) {
            e.preventDefault();
            const dateFrom = $("#dateFrom").val();
            const dateTo = $("#dateTo").val();
            const searchValue = $("#search").val().trim();
            
            console.log("Form submitted");
            console.log("DateFrom:", dateFrom);
            console.log("DateTo:", dateTo);
            console.log("Search:", searchValue);
            
            // If only search value is provided (no dates), use AJAX
            if (searchValue && !dateFrom && !dateTo) {
                console.log("Only search value provided, using AJAX");
                performRealTimeFilter();
                return false;
            }
            
            // If dates are provided, validate them
            if (dateFrom && dateTo) {
                // Validate dates if needed
                if (new Date(dateFrom) > new Date(dateTo)) {
                    alert("تاریخ شروع نباید از تاریخ پایان بزرگتر باشد");
                    return false;
                }
                
                // For date filtering, we'll use server-side filtering
                // Build URL with parameters
                let url = new URL(window.location);
                url.searchParams.set('dateFrom', dateFrom);
                url.searchParams.set('dateTo', dateTo);
                if (searchValue) {
                    url.searchParams.set('search', searchValue);
                } else {
                    url.searchParams.delete('search');
                }
                
                // Redirect to the same page with filter parameters
                window.location.href = url.toString();
            } else if (searchValue) {
                // Only search value, use AJAX
                performRealTimeFilter();
            }
        });
        
        // Sort functionality
        $("#up").on("click", function () {
            const icon = $("#up i");
            icon.toggleClass("fa-arrow-up fa-arrow-down");
            
            // Convert to array for sorting
            const rows = $tableRows.get();
            
            // Toggle sort direction
            if (reversed) {
                $tableBody.append(rows);
            } else {
                $tableBody.append(rows.reverse());
            }
            
            reversed = !reversed;
            
            // Update the rows reference after sorting
            $tableRows = $table.find("tbody tr:visible");
        });
        
        // Handle search input - real-time filtering
        $searchInput.on({
            'input keyup paste': function(e) {
                const searchValue = $(this).val().trim();
                console.log("Search input changed:", searchValue);
                
                // If search is cleared, reload the page to show original pagination
                if (searchValue === '') {
                    console.log("Search cleared, reloading page");
                    // Remove search parameter from URL and reload
                    const url = new URL(window.location);
                    url.searchParams.delete('search');
                    window.location.href = url.toString();
                } else {
                    debouncedFilter(); // Use debounced filtering for real-time updates
                }
            },
            'keypress': function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault();
                    console.log("Enter key pressed - performing immediate filter");
                    clearTimeout(filterTimeout); // Cancel debounced filter
                    performRealTimeFilter(); // Immediate filter
                }
            },
            'search': function() {
                // This event fires when the user clicks the clear (x) button
                console.log("Search cleared via X button");
                const searchValue = $(this).val().trim();
                if (searchValue === '') {
                    // Reload page without search parameter
                    const url = new URL(window.location);
                    url.searchParams.delete('search');
                    window.location.href = url.toString();
                } else {
                    debouncedFilter();
                }
            }
        });
        
        // Initial setup
        $tableRows = $table.find("tbody tr");
        $originalTableRows = $table.find("tbody tr");
        
        // Initialize filtering if there's already a search value (from URL)
        if ($searchInput.val()) {
            console.log("Initializing with existing search value:", $searchInput.val());
            performRealTimeFilter();
        }

        // Add toggle functionality for mobile view to show/hide columns
        if (window.innerWidth <= 768) {
            const tableHeaders = $(".table-modern th");
            tableHeaders.each(function (index) {
                $(this).click(function () {
                    const columnIndex = index + 1;
                    $(".table-modern td:nth-child(" + columnIndex + ")").toggle();
                    $(this).toggleClass("active-column");
                });
            });
        }
    });
</script>

<script>
    $(document).ready(function () {

        // پاک کردن علامت سوال و کوتاه کردن متن‌ها
        function cleanAndTruncateText() {
            $('.clean-text').each(function() {
                let text = $(this).text();
                if (text) {
                    // Remove question marks and clean up extra spaces
                    text = text.replace(/\?/g, '')
                              .replace(/\s+/g, ' ')
                              .trim();
                    
                    // Smart truncation without ellipsis
                    let maxLength = 50;
                    if (text.length > maxLength) {
                        // Find the last complete word within the limit
                        let truncated = text.substring(0, maxLength);
                        let lastSpace = truncated.lastIndexOf(' ');
                        if (lastSpace > maxLength * 0.7) { // If we can find a good break point
                            truncated = truncated.substring(0, lastSpace);
                        }
                        text = truncated;
                    }
                    
                    $(this).text(text);
                }
            });
        }

        // اجرای تابع پاک کردن علامت سوال و کوتاه کردن متن‌ها
        cleanAndTruncateText();
        
        // Calendar positioning fixes for error page
        function enhanceCalendarInputs() {
            $('input[data-jdp]').each(function() {
                const $input = $(this);
                const $wrapper = $input.closest('.filter-controls-single-line, .input-wrapper') || $input.parent();
                
                $input.on('click', function(e) {
                    const $ripple = $('<span class="ripple-effect"></span>');
                    $wrapper.append($ripple);
                    
                    const rect = e.target.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    $ripple.css({
                        width: size + 'px',
                        height: size + 'px',
                        left: x + 'px',
                        top: y + 'px'
                    });
                    
                    setTimeout(() => {
                        $ripple.remove();
                    }, 600);
                });
            });
        }
        
        // Function to position calendar below the clicked input
        function positionCalendarBelowInput($input) {
            const $calendar = $('jdp-container');
            if ($calendar.length > 0 && $input && $input.length > 0) {
                const inputOffset = $input.offset();
                const inputHeight = $input.outerHeight();
                const inputWidth = $input.outerWidth();
                
                // Position calendar
                $calendar.css({
                    'position': 'absolute',
                    'top': (inputOffset.top + inputHeight + 4) + 'px',
                    'left': inputOffset.left + 'px',
                    'z-index': '10002',
                    'min-width': Math.max(inputWidth, 300) + 'px'
                });
            }
        }
        
        // Observer to monitor calendar creation and reposition it
        let currentActiveInput = null;
        
        // Store reference to clicked input
        $(document).on('click', 'input[data-jdp]', function() {
            currentActiveInput = $(this);
        });
        
        // Monitor for calendar appearance
        const calendarObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.tagName === 'JDP-CONTAINER' || 
                        (node.nodeType === 1 && $(node).find('jdp-container').length > 0)) {
                        
                        if (currentActiveInput) {
                            // Quick positioning with minimal delay
                            setTimeout(() => positionCalendarBelowInput(currentActiveInput), 10);
                        }
                    }
                });
            });
        });
        
        // Start observing
        calendarObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Initialize calendar enhancements
        $(document).ready(function() {
            enhanceCalendarInputs();
        });
    });
</script>
{% endblock %}