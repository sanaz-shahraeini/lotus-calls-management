{% load static baseTags userProfileTags %}

<!-- Debug: Show pending_password_reset_count value -->

<!-- Desktop Sidebar -->
{% if 'user' in request.session and not request.session.user|needsPasswordChange %}
<aside id="sidebar"
       class="w-[220px] overflow-y-auto h-screen text-white z-40 fixed top-0 right-0 transform transition-all duration-300 ease-in-out sm:w-[220px] hidden lg:block">
    <div class="sidebar-profile-section text-center">
        <div class="profile-image-container">
            <img src="{% if 'user' in request.session %}{% if request.session.user|getBaseInfo:'picurl'|lower == 'avatar.jpg' %}{% static 'pic/' %}{% else %}{% static 'upload/' %}{% endif %}{{ request.session.user|getBaseInfo:'picurl' }}{% endif %}"
                 alt="Profile" class="profile-image">
        </div>
        <p class="profile-name">
            {% if 'user' in request.session %}{{ request.session.user|capfirst }}{% endif %}</p>
        <p class="profile-extension">
            {% if 'user' in request.session %}{{ request.session.user|getBaseInfo:'extension' }}{% endif %}</p>
        {% if 'user' in request.session %}
            {% with exts=request.session.user|getUserExtensions %}
                {% if exts %}
                    <p class="profile-extension sidebar-extension-list">
                        داخلی‌ها: {{ exts|join:', ' }}
                    </p>
                {% endif %}
            {% endwith %}
        {% endif %}
    </div>
    <nav class="sidebar-nav">
        <a href="{% url 'dashboard' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-tachometer-alt"></i> <span class="ml-2 sidebar-text">داشبورد</span>
        </a>
     
        <a href="{% url 'profile' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-user"></i> <span class="ml-2 sidebar-text" title="پروفایل کاربری">پروفایل کاربری</span>
        </a>
        {% if request.session.user|getBaseInfo:"groupname" != "member" %}
        <a href="{% url 'user' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start relative">
            <i class="fas fa-user-cog"></i> <span class="ml-2 sidebar-text" title="مدیریت کاربران">مدیریت کاربران</span>
            {% if pending_password_reset_count|add:0 > 0 %}
                <span class="sidebar-badge">
                    {{ pending_password_reset_count }}
                </span>
            {% endif %}
        </a>
        <a href="{% url 'settings' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-cogs"></i> <span class="ml-2 sidebar-text" title="مدیریت سیستم">مدیریت سیستم</span>
        </a>
        {% endif %}
    
        {% if request.session.user|hasErrorsAccess %}
        <a href="{% url 'errors' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-exclamation-triangle"></i> <span class="ml-2 sidebar-text">گزارش خطا</span>
        </a>
        {% endif %}
        <a href="{% url 'support' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-question-circle"></i> <span class="ml-2 sidebar-text" title="راهنما">راهنما</span>
        </a>

        <button id="exit"
           class="w-full text-center no-underline text-xs sm:text-sm p-3 flex items-center justify-start">
            <i class="fas fa-sign-out-alt"></i> <span class="ml-2 sidebar-text">خروج</span>
        </button>
    </nav>
</aside>
{% endif %}

<!-- Mobile Sidebar Toggle Button -->
<button id="toggle-menu"
        class="fixed top-4 right-4 text-white p-2 rounded-md z-50 block lg:hidden transition-all transform duration-300 ease-in-out">
    <i id="menu-icon" class="fas fa-bars text-lg"></i>
</button>

<!-- Mobile Sidebar -->
{% if 'user' in request.session and not request.session.user|needsPasswordChange %}
<div id="mobile-sidebar"
     class="fixed overflow-y-auto top-0 right-0 w-[220px] h-screen text-white z-40 transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="sidebar-profile-section text-center">
        <div class="profile-image-container">
            <img src="{% if 'user' in request.session %}{% if request.session.user|getBaseInfo:'picurl'|lower == 'avatar.jpg' %}{% static 'pic/' %}{% else %}{% static 'upload/' %}{% endif %}{{ request.session.user|getBaseInfo:'picurl' }}{% endif %}"
                alt="Profile" class="profile-image">
        </div>
        <p class="profile-name">
            {% if 'user' in request.session %}{{ request.session.user|capfirst }}{% endif %}</p>
        <p class="profile-extension">
            {% if 'user' in request.session %}{{ request.session.user|getBaseInfo:'extension' }}{% endif %}</p>
        {% if 'user' in request.session %}
            {% with exts=request.session.user|getUserExtensions %}
                {% if exts %}
                    <p class="profile-extension sidebar-extension-list">
                        داخلی‌ها: {{ exts|join:', ' }}
                    </p>
                {% endif %}
            {% endwith %}
        {% endif %}
    </div>
    <nav class="sidebar-nav">
        <a href="{% url 'dashboard' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-tachometer-alt"></i> <span class="ml-2 sidebar-text">داشبورد</span>
        </a>
      
        <a href="{% url 'profile' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-user"></i> <span class="ml-2 sidebar-text" title="پروفایل کاربری">پروفایل کاربری</span>
        </a>
        {% if request.session.user|getBaseInfo:"groupname" != "member" %}
        <a href="{% url 'user' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start relative">
            <i class="fas fa-user-cog"></i> <span class="ml-2 sidebar-text" title="مدیریت کاربران">مدیریت کاربران</span>
            {% if pending_password_reset_count|add:0 > 0 %}
                <span class="sidebar-badge">
                    {{ pending_password_reset_count }}
                </span>
            {% endif %}
        </a>
        <a href="{% url 'settings' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-cogs"></i> <span class="ml-2 sidebar-text" title="مدیریت سیستم">مدیریت سیستم</span>
        </a>
        {% endif %}
        {% if request.session.user|hasErrorsAccess %}
        <a href="{% url 'errors' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-exclamation-triangle"></i> <span class="ml-2 sidebar-text">گزارش خطا</span>
        </a>
        {% endif %}
        <a href="{% url 'support' %}"
           class="py-3 text-xs sm:text-sm flex items-center justify-start">
            <i class="fas fa-question-circle"></i> <span class="ml-2 sidebar-text" title="راهنما">راهنما</span>
        </a>

        <button id="exit-mb"
           class="w-full text-center no-underline text-xs sm:text-sm p-3 flex items-center justify-start">
            <i class="fas fa-sign-out-alt"></i> <span class="ml-2 sidebar-text">خروج</span>
        </button>
    </nav>
</div>
{% endif %}

<!-- Logout Confirmation Modal (Desktop) -->
<div id="exitmodal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-[#0D1B2A] rounded-xl p-6 max-w-md w-full shadow-lg border border-gray-100 dark:border-[#37474F] modal-content">
        <div class="flex items-center mb-5">
            <i class="fa-solid fa-circle-question text-2xl mr-3 text-[#00BCD4] modal-icon"></i>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 modal-title mr-2">تأیید خروج</h3>
        </div>
        
        <div class="w-full h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent mb-5 modal-divider"></div>
        
        <p class="mb-6 text-gray-700 dark:text-gray-200 text-right pr-2 leading-relaxed modal-text">
            آیا مطمئن هستید که می‌خواهید از حساب کاربری خود خارج شوید؟
        </p>
        
        <div class="flex justify-end items-center mt-4">
            <button type="button" class="modal-cancel" onclick="document.getElementById('exitmodal').classList.add('hidden');">
                <i class="fa-solid fa-ban mr-2"></i>
                انصراف
            </button>
            <div class="w-4"></div> <!-- فاصله بین دکمه‌ها -->
            <a href="{% url 'logout' %}" class="exit-btn">
                <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>
                خروج
            </a>
        </div>
    </div>
</div>

<!-- Logout Confirmation Modal (Mobile) -->
<div id="exitmodal-mb" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-[#0D1B2A] rounded-xl p-6 max-w-md w-full mx-4 shadow-lg border border-gray-100 dark:border-[#37474F] modal-content">
        <div class="flex items-center mb-5">
            <i class="fa-solid fa-circle-question text-2xl mr-3 text-[#00BCD4] modal-icon"></i>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 modal-title mr-2">تأیید خروج</h3>
        </div>
        
        <div class="w-full h-px bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent mb-5 modal-divider"></div>
        
        <p class="mb-6 text-gray-700 dark:text-gray-200 text-right pr-2 leading-relaxed modal-text">
            آیا مطمئن هستید که می‌خواهید از حساب کاربری خود خارج شوید؟
        </p>
        
        <div class="flex justify-end items-center mt-4">
            <button type="button" class="modal-cancel" onclick="document.getElementById('exitmodal-mb').classList.add('hidden');">
                <i class="fa-solid fa-ban mr-1"></i>
                انصراف
            </button>
            <div class="w-4"></div> <!-- فاصله بین دکمه‌ها -->
            <a href="{% url 'logout' %}" class="exit-btn">
                <i class="fa-solid fa-arrow-right-from-bracket mr-1"></i>
                خروج
            </a>
        </div>
    </div>
</div>

<!-- Mobile sidebar toggle script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleMenu = document.getElementById('toggle-menu');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const menuIcon = document.getElementById('menu-icon');
        
        if (toggleMenu && mobileSidebar) {
            toggleMenu.addEventListener('click', function() {
                if (mobileSidebar.classList.contains('translate-x-full')) {
                    mobileSidebar.classList.remove('translate-x-full');
                    menuIcon.classList.remove('fa-bars');
                    menuIcon.classList.add('fa-times');
                } else {
                    mobileSidebar.classList.add('translate-x-full');
                    menuIcon.classList.remove('fa-times');
                    menuIcon.classList.add('fa-bars');
                }
            });
        }
        
        // Exit modal handlers
        const exitBtn = document.getElementById('exit');
        const exitBtnMobile = document.getElementById('exit-mb');
        const exitModal = document.getElementById('exitmodal');
        const exitModalMobile = document.getElementById('exitmodal-mb');
        
        if (exitBtn && exitModal) {
            exitBtn.addEventListener('click', function() {
                exitModal.classList.remove('hidden');
                setTimeout(() => {
                    exitModal.style.opacity = '1';
                    exitModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            });
        }
        
        if (exitBtnMobile && exitModalMobile) {
            exitBtnMobile.addEventListener('click', function() {
                exitModalMobile.classList.remove('hidden');
                setTimeout(() => {
                    exitModalMobile.style.opacity = '1';
                    exitModalMobile.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            });
        }
    });
</script>